<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fed-WSVAD Documentation</title>

  <link id="hljs-light" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" />
  <link id="hljs-dark" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"
    disabled />

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">


  <style>
    /* —— Color Variables (Refined Palette) —— */
    :root {
      --bg: #f8f9fa; /* Slightly softer white background */
      --text: #343a40; /* Darker text for better contrast */
      --sidebar-bg: #e9ecef; /* Light grey sidebar */
      --sidebar-border: #dee2e6; /* Subtle border */
      --link: #007bff; /* Vibrant blue link */
      --link-hover: #0056b3; /* Darker blue on hover */
      --active-bg: #cce5ff; /* Lighter blue for active items */
      --code-bg: #e9ecef; /* Match sidebar background for code blocks */
      --code-border: #ced4da; /* Slightly darker code border */
      --btn-bg: #007bff; /* Match link color for buttons */
      --btn-text: #ffffff;
      --btn-hover: #0056b3;
      --footer-text: #6c757d; /* Muted footer text */
      --transition: 0.3s ease-in-out; /* Slightly longer transition */
      --img-shadow: rgba(0,0,0,0.15); /* Slightly stronger image shadow */

      /* Table Specific Colors */
      --table-border: #dee2e6;
      --table-header-bg: #e9ecef;
      --table-row-even-bg: #f2f2f2; /* More distinct zebra stripe */
    }

    body.dark {
      --bg: #212529; /* Dark background */
      --text: #dee2e6; /* Light text */
      --sidebar-bg: #343a40; /* Darker grey sidebar */
      --sidebar-border: #495057; /* Subtle border */
      --link: #007bff; /* Keep vibrant blue link */
      --link-hover: #0056b3; /* Darker blue on hover */
      --active-bg: #007bff40; /* Subtle blue highlight for dark mode */
      --code-bg: #343a40; /* Match sidebar background for code blocks */
      --code-border: #495057; /* Slightly darker code border */
      --btn-bg: #007bff; /* Match link color for buttons */
      --btn-text: #ffffff;
      --btn-hover: #0056b3;
      --footer-text: #adb5bd; /* Lighter muted footer text */
      --img-shadow: rgba(0,0,0,0.4); /* Slightly stronger image shadow */

      /* Table Specific Colors (Dark Mode) */
      --table-border: #495057;
      --table-header-bg: #343a40;
      --table-row-even-bg: #2c3034; /* More distinct zebra stripe */
    }

    /* —— Base Styles —— */
    * {
      box-sizing: border-box;
      transition: background-color var(--transition),
        color var(--transition), border-color var(--transition), box-shadow var(--transition); /* Added box-shadow to transition */
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
        Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      font-size: 16px;
      line-height: 1.7;
      color: var(--text);
      background-color: var(--bg);
      display: flex; /* Use flexbox for main layout */
      height: 100vh;
      overflow: hidden; /* Hide overflow on body to manage scrolling on #content */
    }

    /* —— Sidebar —— */
    #sidebar {
      position: fixed; /* Keep fixed position */
      top: 0;
      left: 0;
      bottom: 0;
      width: 260px; /* Fixed width sidebar */
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1.5rem 1rem;
      flex-shrink: 0; /* Prevent sidebar from shrinking in flex layout */
      z-index: 500; /* Ensure sidebar is above content but below fixed buttons */
      box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* Subtle shadow for sidebar */
    }

    #navList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #navList li {
      margin: 0.6rem 0;
    }

    /* Style for all links in the nav */
    #navList a {
      display: block;
      text-decoration: none;
      color: var(--link); /* Default link color */
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      font-weight: 500;
      word-wrap: break-word; /* Ensure long text wraps */
      transition: background-color var(--transition), color var(--transition); /* Added color transition */
    }

    /* Style for folder links (top level within a folder group) */
    #navList li > a:first-child:not(.folder) {
        color: var(--text); /* Folder link text color same as body text */
        font-weight: 600; /* Make folder links bolder */
    }

    /* Style for nested list links (二级列表) */
    #navList ul li a {
        color: var(--link); /* Apply the standard link color (blue) */
        font-weight: 500; /* Standard font weight for nested links */
    }


    #navList a:hover {
      background-color: var(--active-bg);
      color: var(--link-hover);
    }

    #navList a.active {
      background-color: var(--active-bg);
      color: var(--link-hover);
      font-weight: 700;
      box-shadow: inset 3px 0 0 0 var(--link); /* Highlight bar on the left */
      padding-left: calc(0.8rem - 3px); /* Adjust padding to compensate for the bar */
    }

    #navList ul {
      margin-left: 1.2rem;
      padding-left: 0.5rem;
      border-left: 1px solid var(--sidebar-border);
    }
      #navList ul li {
        margin: 0.4rem 0;
      }

    .maintainer {
      margin-top: auto; /* Pushes the element to the bottom */
      padding-top: 1.5rem;
      font-size: 1.2rem; /* Slightly reduced font size */
      color: var(--footer-text);
      text-align: left;
      padding-left: 0.8rem;
      font-family: 'Great Vibes', cursive; /* Apply Great Vibes font */
      font-weight: 700; /* Make it bold */
    }

    /* —— Theme Toggle Button —— */
    #themeToggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000; /* Ensure it's on top */
      border: 1px solid var(--sidebar-border);
      background-color: var(--sidebar-bg);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
    }

    #themeToggle:hover {
      background-color: var(--code-bg);
      border-color: var(--link);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    #themeToggle:active {
        transform: scale(0.95);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* —— Back Button —— */
    #backButton {
      position: fixed;
      top: 3rem; /* Moved down to avoid overlap */
      left: calc(260px + 1rem); /* Position to the right of the sidebar + 1rem margin */
      z-index: 1000; /* Ensure it's on top */
      border: 1px solid var(--sidebar-border);
      background-color: var(--sidebar-bg);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
    }

    #backButton:hover {
      background-color: var(--code-bg);
      border-color: var(--link);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
     #backButton:active {
        transform: scale(0.95);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }


    /* —— Content Area (Full width next to sidebar, handles scrolling) —— */
    #content {
      flex-grow: 1; /* Allow content to grow and fill space */
      overflow-y: auto; /* Add scrollbar to this area */
      padding: 0; /* Remove padding here, apply to wrapper */
      margin-left: 260px; /* Push content area next to sidebar */
      /* Removed padding-right: 1rem; from here to allow footer to span full width */
    }

    /* —— Badges Container (Directly added to HTML) —— */
    #topBadges {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0.5rem; /* Added small gap between badges */
      margin: 1.5em 0;
      width: auto;
      padding: 0 2.5rem;
      box-sizing: border-box;
      align-self: flex-start;
    }

    #topBadges img {
        max-width: none;
        height: auto;
        display: inline-block;
        margin: 0;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        background-color: transparent;
        /* Ensure images don't cause horizontal scroll */
        max-width: 100%;
        height: auto;
    }

    #topBadges a {
        text-decoration: none;
    }


    /* —— Content Wrapper (Centers content within #content) —— */
    .content-wrapper {
      max-width: 70%;
      width: 100%;
      margin: 0 auto;
      padding: 0 2.5rem; /* Keep padding here for main content */
      padding-top: 0;
      padding-bottom: 2rem;
      box-sizing: border-box;
      flex-shrink: 0;
      align-self: center;
    }

    /* —— Table of Contents Styling —— */
    .content-wrapper ol:first-of-type,
    .content-wrapper ul:first-of-type {
        list-style: none;
        padding-left: 0;
        margin-top: 1.5em;
        margin-bottom: 2em;
        background-color: var(--code-bg);
        border: 1px solid var(--code-border);
        border-radius: 8px;
        padding: 1.5em;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .content-wrapper ol:first-of-type ul,
    .content-wrapper ul:first-of-type ul {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        padding-left: 1.5em;
        border-left: 2px solid var(--sidebar-border);
    }

    .content-wrapper ol:first-of-type li,
    .content-wrapper ul:first-of-type li {
        margin-bottom: 0.8em;
        line-height: 1.4;
        position: relative;
        padding-left: 1.2em;
    }

      .content-wrapper ol:first-of-type ul li,
      .content-wrapper ul:first-of-type ul li {
        margin-bottom: 0.4em;
      }

    /* Custom marker for ToC list items */
    .content-wrapper ol:first-of-type li::before,
    .content-wrapper ul:first-of-type li::before {
        content: "➤";
        color: var(--link);
        position: absolute;
        left: 0;
        top: 0.1em;
        font-size: 0.8em;
        font-weight: bold;
    }
      .content-wrapper ol:first-of-type ul li::before,
      .content-wrapper ul:first-of-type ul li::before {
          content: "•";
          color: var(--footer-text);
          font-size: 1em;
          top: 0.2em;
      }

    .content-wrapper li a {
        font-weight: 400;
        text-decoration: none;
        color: var(--text);
        transition: color var(--transition);
    }

    .content-wrapper li a:hover {
        color: var(--link);
        text-decoration: underline;
    }

    /* Style for the ToC heading (if it's an h2) */
    .content-wrapper h2:first-of-type {
        margin-top: 0;
        margin-bottom: 1.5em;
        border-bottom: none;
        padding-bottom: 0;
        font-size: 1.6em;
        color: var(--text);
    }

    /* —— Headings —— */
    .content-wrapper h1,
    .content-wrapper h2,
    .content-wrapper h3,
    .content-wrapper h4,
    .content-wrapper h5,
    .content-wrapper h6 {
      margin-top: 2em;
      margin-bottom: 1em;
      font-weight: 600;
      line-height: 1.3;
    }

    .content-wrapper h1 {
      font-size: 2.2em;
      border-bottom: 1px solid var(--sidebar-border);
      padding-bottom: 0.4em;
    }

    .content-wrapper h2 {
      font-size: 1.8em;
        border-bottom: 1px dashed var(--sidebar-border);
        padding-bottom: 0.3em;
    }
    .content-wrapper h3 {
        font-size: 1.4em;
    }

    /* —— Paragraphs —— */
    .content-wrapper p {
      margin: 0 0 1.2em 0;
    }

    /* —— Code & Preformatted Blocks —— */
    .content-wrapper pre {
      background-color: var(--code-bg);
      border: 1px solid var(--code-border);
      padding: 1.2rem;
      border-radius: 8px;
      position: relative;
      overflow-x: auto;
      margin: 1.5em 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow for code blocks */
    }

    .content-wrapper code:not(pre code) { /* Inline code */
      background-color: var(--code-bg);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.9em;
      border: 1px solid var(--code-border);
    }
    .content-wrapper pre code { /* Code within pre blocks */
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.95em;
      background-color: transparent;
      border: none;
      padding: 0;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 5px;
      cursor: pointer;
      opacity: 0.7;
      transition: background-color var(--transition), color var(--transition), opacity 0.15s ease;
    }
    .content-wrapper pre:hover .copy-btn {
        opacity: 1;
    }

    .copy-btn:hover {
      background: var(--btn-hover);
      opacity: 1;
    }
    .copy-btn.copied {
        background: #28a745;
        color: white;
    }

    /* —— Links, Tables, Blockquotes —— */
    .content-wrapper a {
      color: var(--link);
      text-decoration: none;
    }

    .content-wrapper a:hover {
      text-decoration: underline;
      color: var(--link-hover);
    }

    .content-wrapper table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.8em 0;
      box-shadow: 0 2px 4px var(--img-shadow);
      border-radius: 6px;
      overflow: hidden;
    }

    .content-wrapper th,
    .content-wrapper td {
      border: 1px solid var(--table-border);
      padding: 0.8em 1.2em;
      text-align: left;
    }
    .content-wrapper th {
        background-color: var(--table-header-bg);
        font-weight: 600;
    }
    .content-wrapper tr:nth-child(even) {
        background-color: var(--table-row-even-bg);
    }

    .content-wrapper blockquote {
      border-left: 5px solid var(--link);
      padding: 1em 1.5em;
      margin: 1.8em 0;
      background-color: var(--code-bg);
      border-radius: 0 6px 6px 0;
      color: var(--footer-text);
    }
    .content-wrapper blockquote p:last-child {
        margin-bottom: 0;
    }

    /* —— Images (including SVG) —— */
    .content-wrapper img {
      max-width: 60%;
      height: auto;
      display: block;
      margin: 1.5em auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--img-shadow);
      background-color: var(--bg);
    }

    /* —— Key Contributions List Styling —— */
    .content-wrapper ul:not(:first-of-type) {
        list-style: none;
        padding-left: 1.5em;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
    }

     .content-wrapper ul:not(:first-of-type) li {
         margin-bottom: 0.8em;
         position: relative;
     }

     /* Custom marker for Key Contributions list items */
     .content-wrapper ul:not(:first-of-type) li::before {
         content: "→";
         color: var(--link);
         position: absolute;
         left: -1.5em;
         top: 0.1em;
         font-weight: bold;
     }

    /* —— Clustrmaps Specific Styles —— */
    #pageFooter {
      text-align: center; /* Center the clustrmaps */
      padding: 2em 0 3em 0; /* Add top and bottom padding */
      margin-top: 3em; /* Space above the footer */
      border-top: 1px solid var(--sidebar-border); /* Subtle separator */
      background-color: var(--sidebar-bg); /* Match sidebar/code block background */
      color: var(--footer-text);
      font-size: 0.9em;
      box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }

    #clustrmapsContainer {
      display: block; /* Changed to block display */
      width: 100%; /* Explicitly set width to 100% */
      max-width: 100%; /* Ensure it's responsive */
      margin: 0 auto; /* Center it */
      height: auto;
      overflow: hidden; /* Hide any overflow */
      border-radius: 8px; /* Consistent rounded corners */
      box-shadow: 0 4px 12px var(--img-shadow); /* Consistent shadow */
      background-color: var(--bg); /* Clustrmaps itself might have a transparent background, provide one */
      padding: 5px; /* Small inner padding if needed */
    }

    #clustrmapsContainer img {
      display: block; /* Remove extra space below image */
      max-width: 100%;
      height: auto;
      border-radius: 6px; /* Slightly smaller border radius for the image itself */
    }


      /* Responsive adjustments */
    @media (max-width: 768px) {
        #sidebar {
            width: 200px; /* Slightly reduce sidebar width on smaller screens */
            padding: 1rem 0.8rem;
        }
        #backButton {
            left: calc(200px + 0.8rem); /* Adjust back button position */
            top: 1rem; /* Move back button closer to top on mobile */
            padding: 0.3rem 0.8rem;
            font-size: 14px;
        }
         #themeToggle {
             top: 0.8rem;
             right: 0.8rem;
             width: 35px;
             height: 35px;
             font-size: 18px;
         }
        #content {
            margin-left: 200px; /* Adjust content margin */
            /* Removed padding-right from here */
        }
        .content-wrapper {
            max-width: 95%; /* Allow content to take more width */
            padding: 0 1rem;
        }
        .content-wrapper img {
            max-width: 90%; /* Allow images to be larger */
        }
         .maintainer {
             font-size: 1rem; /* Further reduce maintainer font size */
             padding-left: 0.5rem;
         }
         .content-wrapper h1 {
             font-size: 1.8em;
         }
         .content-wrapper h2 {
             font-size: 1.5em;
         }
         .content-wrapper h3 {
             font-size: 1.2em;
         }
         .content-wrapper pre {
             padding: 0.8rem;
         }
         .content-wrapper table th,
         .content-wrapper table td {
             padding: 0.5em 0.8em;
         }
    }

  </style>
</head>
<body>
  <nav id="sidebar">
    <div class="nav-container">
      <ul id="navList">
        <li><a href="#README.md">Home</a></li>
        <li>
          <a href="https://github.com/rekkles2/Fed_WSVAD/tree/main/Backbone" target="_blank" rel="noopener noreferrer">Backbone</a>
          <ul>
            <li><a href="#Backbone/README.md">Feature Extraction Guide (VideoMAE V2 Backbone)</a></li>
          </ul>
        </li>
        <li>
          <a href="https://github.com/rekkles2/Fed_WSVAD/tree/main/Fed_VAD" target="_blank" rel="noopener noreferrer">Fed-VAD</a>
          <ul>
            <li><a href="#Fed_VAD/Jetson%20AGX%20Xavier%20Deployment%20Guide.md">Jetson AGX Xavier Deployment Guide</a></li>
            <li><a href="#Fed_VAD/README.md">Federated Setup (Fed-WSVAD)</a></li>
          </ul>
        </li>
        <li><a href="https://deepwiki.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer">DeepWiki Code Navigator</a></li>
      </ul>
    </div>
    <div class="maintainer">Maintained by Jiahang Li</div>
  </nav>

  <button id="themeToggle" aria-label="Toggle dark/light mode">🌙</button>
  <button id="backButton">← Back</button>

  <main id="content">
    <div id="topBadges">
      <a href="https://github.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/github/stars/rekkles2/Fed_WSVAD?style=flat-square&logo=github&logoColor=white"
          alt="GitHub Stars"
        />
      </a>
      <a href="https://rekkles2.github.io/Fed_WSVAD/#README.md" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/badge/%F0%9F%8C%90-Project%20Page-0084FF?style=flat-square"
          alt="Project Page"
        />
      </a>
      <a href="https://github.com/rekkles2/Fed_WSVAD/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/github/license/rekkles2/Fed_WSVAD?style=flat-square&logo=apache&logoColor=white&color=brightgreen"
          alt="License"
        />
      </a>
    </div>
    <div class="content-wrapper">
      <p>Loading...</p>
    </div>
    <footer id="pageFooter">
      <div id="clustrmapsContainer">
        <noscript>
          <a href='https://clustrmaps.com/site/1c67u' title='Visit tracker'>
            <img id="clustrmapsNoJs" src='//clustrmaps.com/map_v2.png?cl=ffffff&w=a&t=tt&d=5vXVLxUQJKZmhtb1zgYwBSdr65TUyHOP2wBiSDJj2Os'/>
          </a>
        </noscript>
      </div>
    </footer>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script>
    // --- Theme Toggle Functionality ---
    const themeToggleBtn = document.getElementById('themeToggle');
    const lightStyle = document.getElementById('hljs-light');
    const darkStyle = document.getElementById('hljs-dark');
    const savedTheme = localStorage.getItem('theme');

    // --- Clustrmaps Theme Update Function ---
    function updateClustrmapsTheme(isDarkMode) {
      const clustrmapsContainer = document.getElementById('clustrmapsContainer');
      if (!clustrmapsContainer) return;

      const mapColor = isDarkMode ? '212529' : 'ffffff'; // Dark mode: matches body background, Light mode: white
      const siteId = '5vXVLxUQJKZmhtb1zgYwBSdr65TUyHOP2wBiSDJj2Os'; // Your Clustrmaps site ID

      // Update the No-JS image fallback's src
      const noJsImage = document.getElementById('clustrmapsNoJs');
      if (noJsImage) {
        const currentSrc = noJsImage.src;
        const newSrc = currentSrc.replace(/cl=[a-fA-F0-9]{6}/, `cl=${mapColor}`);
        if (newSrc !== currentSrc) {
          noJsImage.src = newSrc;
        }
      }

      // Remove existing Clustrmaps script to ensure it reloads with new parameters
      let existingScript = document.getElementById('clustrmaps');
      if (existingScript) {
        existingScript.remove();
      }

      // Create and append new Clustrmaps script
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.id = 'clustrmaps'; // Assign an ID for future reference
      script.src = `//cdn.clustrmaps.com/map_v2.js?cl=${mapColor}&w=a&t=tt&d=${siteId}`; // Corrected URL format
      clustrmapsContainer.appendChild(script);
    }

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        if (lightStyle) lightStyle.disabled = true;
        if (darkStyle) darkStyle.disabled = false;
        themeToggleBtn.textContent = '☀️'; // Sun icon for dark mode
      } else {
        document.body.classList.remove('dark');
        if (lightStyle) lightStyle.disabled = false;
        if (darkStyle) darkStyle.disabled = true;
        themeToggleBtn.textContent = '🌙'; // Moon icon for light mode
      }
      updateClustrmapsTheme(theme === 'dark');
    }

    // Apply saved theme or system preference on load
    applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    // Event listener for theme toggle button
    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });

    // --- Markdown Loading and Processing ---
    const contentDiv = document.querySelector('.content-wrapper');
    let currentFile = null; // Tracks the currently loaded markdown file
    const GITHUB_REPO_RAW_BASE_URL = 'https://raw.githubusercontent.com/rekkles2/Fed_WSVAD/main/';
    const HOME_README_URL = 'https://raw.githubusercontent.com/rekkles2/page/main/README.md';

    // Generates a valid HTML ID from a string (e.g., for heading anchors)
    function generateValidId(input) {
      // Replace invalid characters with hyphens, remove leading/trailing hyphens
      return input.trim().toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    // Fetches and renders Markdown content
    async function loadContent(filePath) { // Renamed from loadMarkdown to loadContent for consistency
      // Clear previous content and display loading message
      contentDiv.innerHTML = '<p>Loading content...</p>';

      try {
        // Determine the correct URL for the markdown file
        const isHomePage = filePath === 'README.md';
        const fileUrl = isHomePage ? HOME_README_URL : GITHUB_REPO_RAW_BASE_URL + filePath;
        const response = await fetch(fileUrl);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status} for ${fileUrl}`);
        }
        const markdownText = await response.text();

        // Parse Markdown to HTML using 'marked' library
        let parsedHtml = marked.parse(markdownText);

        // Insert parsed markdown into the content wrapper
        contentDiv.innerHTML = parsedHtml;


        // --- Link Handling ---
        // Determine the base URL for resolving relative links within the current markdown file
        const currentFileDirectory = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/') + 1) : '';
        const baseUrlForRelativeLinks = (isHomePage) ?
                                         new URL(HOME_README_URL).href.substring(0, new URL(HOME_README_URL).href.lastIndexOf('/') + 1) : // Base of the 'page' repo
                                         new URL(currentFileDirectory, GITHUB_REPO_RAW_BASE_URL).href;

        // After inserting HTML, find all links and headings to correct internal links
        const headings = contentDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const links = contentDiv.querySelectorAll('a');

        // Generate IDs for headings if they don't have them
        headings.forEach(heading => {
            if (!heading.id) {
                 heading.id = generateValidId(heading.textContent.trim());
            }
        });


        links.forEach(link => {
          const href = link.getAttribute('href');
          if (href) {
            // Handle relative links (not starting with #, http, mailto)
            if (!href.startsWith('#') && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('mailto:')) {
              const parts = href.split('#');
              const pathPart = parts[0];
              const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';

              if (pathPart.toLowerCase().endsWith('.md')) {
                // Convert relative .md links to internal hash links for SPA navigation
                let absolutePath;
                // Resolve relative path based on the current markdown file's directory
                absolutePath = new URL(pathPart, baseUrlForRelativeLinks).pathname;
                // Make path relative to GITHUB_REPO_RAW_BASE_URL's path part if it's not the home page
                   if (!isHomePage) {
                       let baseRepoPath = new URL(GITHUB_REPO_RAW_BASE_URL).pathname;
                       if (absolutePath.startsWith(baseRepoPath)) {
                         absolutePath = absolutePath.substring(baseRepoPath.length);
                       }
                   }
                   absolutePath = absolutePath.replace(/^\//, ''); // Ensure no leading slash for hash

                link.setAttribute('href', '#' + absolutePath + internalHashPart); // Use original path in hash

              } else {
                // Convert other relative links (assets, etc.) to absolute raw GitHub URLs
                const absoluteUrl = new URL(href, baseUrlForRelativeLinks).href;
                link.setAttribute('href', absoluteUrl);
                link.setAttribute('target', '_blank'); // Open asset links in new tab
                link.setAttribute('rel', 'noopener noreferrer');
              }
            } else if (href.startsWith('https://github.com/rekkles2/Fed_WSVAD/blob/main/')) {
              // Convert GitHub blob links to internal hash links
              const repoPathWithHash = href.substring('https://github.com/rekkles2/Fed_WSVAD/blob/main/'.length);
              const parts = repoPathWithHash.split('#');
              const pathPart = parts[0];
              const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';
              link.setAttribute('href', '#' + pathPart + internalHashPart);
            } else if (href.startsWith('#') && href.length > 1) {
                // It's an internal page hash link (e.g., #section)
                const originalSectionId = href.substring(1); // Get the original section ID from Markdown

                // Try to find a heading element whose generated ID matches the original section ID
                // Convert NodeList to Array to use find() method
                const headingsArray = Array.from(headings);
                let targetElement = headingsArray.find(heading => generateValidId(heading.textContent.trim()) === generateValidId(originalSectionId));

                // Fallback: If finding by generated ID of heading text fails,
                // try finding by the exact originalSectionId from the link's href.
                // This is necessary because Markdown parsers might generate IDs differently
                // for list items compared to headings.
                if (!targetElement) {
                   targetElement = contentDiv.querySelector('#' + originalSectionId);
                }

                // Final fallback: Try to find an element whose text content closely matches the link text
                  if (!targetElement) {
                      const linkText = link.textContent.trim();
                      if (linkText) {
                          // Look for any element that might contain this text and is a potential target
                          // This is a broad search and might need refinement based on actual HTML structure
                          // We'll try to find a heading with matching text content first
                          targetElement = headingsArray.find(heading => heading.textContent.trim() === linkText);

                          // If not found in headings, try a broader search within the content wrapper
                          if (!targetElement) {
                              targetElement = contentDiv.querySelector(`*:has(a[href="${href}"])`); // Find the parent element of the link
                              if (targetElement && targetElement !== link.parentElement) {
                                   // If the parent is found and it's not just the link itself,
                                   // try to find a heading or other block element within it
                                   targetElement = targetElement.querySelector('h1, h2, h3, h4, h5, h6, p, div'); // Broad search
                              }
                          }
                          // As a last resort, try finding any element with a matching generated ID from the link text
                          if (!targetElement) {
                               const generatedIdFromLinkText = generateValidId(linkText);
                               targetElement = contentDiv.querySelector('#' + generatedIdFromLinkText);
                          }
                      }
                  }


                if (targetElement && targetElement.id) {
                    // If a target element with an ID is found, update the link href to point to its ID
                    link.setAttribute('href', '#' + filePath + '#' + targetElement.id); // Format: #FilePath.md#target-id
                } else {
                    console.warn(`Could not find a reliable target element for internal link: ${href} in ${filePath}. Link text: "${link.textContent.trim()}"`);
                    // If target not found, modify to a potentially invalid hash that includes the file path
                    link.setAttribute('href', '#' + filePath + href); // Keep original hash part but add file path
                }
            }

              // Ensure all external HTTP/HTTPS links open in a new tab
              if ((href.startsWith('http://') || href.startsWith('https://')) && !link.getAttribute('href').startsWith('#')) {
                // Check if it's not already targeting _blank and not an internal SPA link
                if (link.getAttribute('target') !== '_blank') {
                    try {
                        const linkUrl = new URL(link.href); // Use link.href to get absolute URL
                        const currentLocUrl = new URL(window.location.href);
                        if (linkUrl.hostname !== currentLocUrl.hostname || linkUrl.protocol !== currentLocUrl.protocol) {
                            link.setAttribute('target', '_blank');
                            link.setAttribute('rel', 'noopener noreferrer');
                        }
                    } catch (e) {
                        console.error("Error processing link URL:", e);
                    }
                }
            }
          }
        });

        // Add IDs to headings if they don't have them (Redundant after first pass, but harmless)
        headings.forEach(heading => {
            if (!heading.id) {
                 heading.id = generateValidId(heading.textContent.trim());
            }
        });


        // Add "Copy" buttons to code blocks
        document.querySelectorAll('pre').forEach(preElement => {
          if (preElement.querySelector('code') && !preElement.querySelector('.copy-btn')) {
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-btn';
            copyButton.textContent = 'Copy';
            copyButton.setAttribute('aria-label', 'Copy code to clipboard');
            copyButton.onclick = () => {
              const codeToCopy = preElement.querySelector('code').innerText;
              navigator.clipboard.writeText(codeToCopy).then(() => {
                copyButton.textContent = 'Copied!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                  copyButton.textContent = 'Copy';
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy text: ', err);
                copyButton.textContent = 'Error';
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
              });
            };
            preElement.appendChild(copyButton);
          }
        });

        // Apply syntax highlighting using highlight.js
        if (typeof hljs !== 'undefined') {
            hljs.highlightAll();
        }


        // Update active link in the sidebar navigation
        document.querySelectorAll('#navList a').forEach(navLink => {
          const navHref = navLink.getAttribute('href');
          // Only apply 'active' to internal hash links
          if (navHref && navHref.startsWith('#')) {
            const hashParts = navHref.substring(1).split('#');
            const navFilePathEncoded = hashParts[0]; // The file path part from the link href (might be encoded)
            const navFilePathDecoded = decodeURIComponent(navFilePathEncoded); // Decode the link's file path

            // Compare the decoded link file path with the current loaded file path
            navLink.classList.toggle('active', navFilePathDecoded === filePath);
          } else {
            navLink.classList.remove('active'); // External links should not be marked active
          }
        });

        // Scroll to the top of the content or to a specific section if a hash is present
        const urlHash = window.location.hash;
        if (urlHash) {
          const hashContent = decodeURIComponent(urlHash.slice(1));
          const hashParts = hashContent.split('#');
          const filePartOfHash = hashParts[0]; // e.g., README.md or Backbone/README.md
          const sectionHashPart = hashParts.length > 1 ? hashParts[1] : ''; // e.g., introduction

          // Only scroll if the file part of the hash matches the currently loaded file
          if (filePartOfHash === filePath && sectionHashPart) {
            // Find the element with the valid ID matching the section hash (which should be the generated ID)
            const elementToScroll = document.getElementById(sectionHashPart); // Changed to use document.getElementById directly
            if (elementToScroll && contentDiv.contains(elementToScroll)) { // Check if element is within contentDiv
              elementToScroll.scrollIntoView({ behavior: 'smooth' });
            } else {
              console.warn(`Element with ID #${sectionHashPart} not found in ${filePath}.`);
              contentDiv.scrollTop = 0; // Scroll to top if section not found
            }
          } else if (filePartOfHash === filePath) { // File matches, but no specific section
            contentDiv.scrollTop = 0;
          }
          // If filePartOfHash does not match filePath, scrolling is handled by the new page load.
        } else {
          contentDiv.scrollTop = 0; // Scroll to top if no hash at all
        }

        currentFile = filePath; // Update the currently loaded file
      } catch (error) {
        console.error('Failed to load Markdown:', error);
        contentDiv.innerHTML = `<p style="color:red; font-weight:bold;">Failed to load content for "${filePath}".</p><p style="color:var(--text);">Error: ${error.message}</p><p>Please check the console for more details.</p>`;
      }
    }

    // Handles URL hash changes for navigation
    function onHashChange() {
      let hash = decodeURIComponent(location.hash.slice(1));

      if (!hash) { // If no hash, load default README.md
        hash = 'README.md';
        history.replaceState(null, '', '#' + hash); // Update URL without triggering hashchange
      }

      const hashParts = hash.split('#');
      const filePathFromHash = hashParts[0]; // This is the path to the .md file

      if (filePathFromHash && filePathFromHash.toLowerCase().endsWith('.md')) {
        // If the file path from hash is different from currentFile, load it.
        // Or, if it's the same file but currentFile is null (initial load), load it.
        if (filePathFromHash !== currentFile || currentFile === null) {
          loadContent(filePathFromHash);
        } else {
          // Same file is already loaded, just handle scrolling to section if specified
          const sectionHashPart = hashParts.length > 1 ? hashParts[1] : '';
          if (sectionHashPart) {
            // Find the element with the valid ID matching the section hash (which is a generated ID)
            const elementToScroll = document.getElementById(sectionHashPart); // Changed to use document.getElementById directly
            if (elementToScroll && contentDiv.contains(elementToScroll)) { // Check if element is within contentDiv
              elementToScroll.scrollIntoView({ behavior: 'smooth' });
            } else {
                 console.warn(`Element with ID #${sectionHashPart} not found for same-file scroll in ${filePathFromHash}.`);
                 contentDiv.scrollTop = 0; // Scroll to top if section not found
            }
          } else {
            contentDiv.scrollTop = 0; // Scroll to top if no internal hash for the same file
          }
        }
      } else if (filePathFromHash) { // If hash is not an .md file but exists
        console.warn(`Invalid or non-Markdown file path in hash: "${filePathFromHash}". Loading default README.md`);
        history.replaceState(null, '', '#README.md');
        loadContent('README.md');
      }
      // If filePathFromHash is empty (e.g. URL is just `#`), it defaults to README.md due to the `!hash` check earlier.
    }

    // Ensure sidebar links and badge links are correctly formatted for external targets
    document.querySelectorAll('#sidebar a, #topBadges a').forEach(link => {
        const href = link.getAttribute('href');
        if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            // Check if it's not already targeting _blank and not an internal SPA link
            if (!link.hasAttribute('target') || link.getAttribute('target') !== '_blank') {
                try {
                    const linkUrl = new URL(link.href); // Use link.href to get absolute URL
                    const currentLocUrl = new URL(window.location.href);
                    if (linkUrl.hostname !== currentLocUrl.hostname || linkUrl.protocol !== currentLocUrl.protocol) {
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                } catch (e) {
                    console.error("Error processing link URL for target='_blank':", href, e);
                     link.setAttribute('target', '_blank');
                     link.setAttribute('rel', 'noopener noreferrer');
                }
            }
        }
    });

    // Add event listener for the back button
    document.getElementById('backButton').addEventListener('click', () => {
        history.back();
    });


    // Event listeners for page load and hash changes
    window.addEventListener('hashchange', onHashChange);
    window.addEventListener('load', () => {
      if (typeof hljs !== 'undefined') {
        // Ensure highlight.js is available before calling
        hljs.configure({ ignoreUnescapedHTML: true }); // Optional: good for robustness
        // Initial highlighting might be better done after first loadMarkdown completes
      }
      onHashChange(); // Initial content load based on hash or default
    });
  </script>
</body>
</html>
