<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fed-WSVAD Documentation</title>

    <!-- Highlight.js CSS for code syntax highlighting (light theme) -->
    <link id="hljs-light" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" />
    <!-- Highlight.js CSS for code syntax highlighting (dark theme), initially disabled -->
    <link id="hljs-dark" rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"
        disabled />

    <!-- Google Fonts for custom typography -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

    <style>
        /* —— Color Variables (Refined Palette) —— */
        :root {
            --bg: #f8f9fa; /* Slightly softer white background */
            --text: #343a40; /* Darker text for better contrast */
            --sidebar-bg: #e9ecef; /* Light grey sidebar */
            --sidebar-border: #dee2e6; /* Subtle border */
            --link: #007bff; /* Vibrant blue link */
            --link-hover: #0056b3; /* Darker blue on hover */
            --active-bg: #cce5ff; /* Lighter blue for active items */
            --code-bg: #e9ecef; /* Match sidebar background for code blocks */
            --code-border: #ced4da; /* Slightly darker code border */
            --btn-bg: #007bff; /* Match link color for buttons */
            --btn-text: #ffffff;
            --btn-hover: #0056b3;
            --footer-text: #6c757d; /* Muted footer text */
            --transition: 0.3s ease-in-out; /* Slightly longer transition */
            --img-shadow: rgba(0,0,0,0.15); /* Slightly stronger image shadow */

            /* Table Specific Colors */
            --table-border: #dee2e6;
            --table-header-bg: #e9ecef;
            --table-row-even-bg: #f2f2f2; /* More distinct zebra stripe */
        }

        /* Dark mode variables */
        body.dark {
            --bg: #212529; /* Dark background */
            --text: #dee2e6; /* Light text */
            --sidebar-bg: #343a40; /* Darker grey sidebar */
            --sidebar-border: #495057; /* Subtle border */
            --link: #007bff; /* Keep vibrant blue link */
            --link-hover: #0056b3; /* Darker blue on hover */
            --active-bg: #007bff40; /* Subtle blue highlight for dark mode */
            --code-bg: #343a40; /* Match sidebar background for code blocks */
            --code-border: #495057; /* Slightly darker code border */
            --btn-bg: #007bff;
            --btn-text: #ffffff;
            --btn-hover: #0056b3;
            --footer-text: #adb5bd; /* Lighter muted footer text */
            --img-shadow: rgba(0,0,0,0.4); /* Slightly stronger image shadow */

            /* Table Specific Colors (Dark Mode) */
            --table-border: #495057;
            --table-header-bg: #343a40;
            --table-row-even-bg: #2c3034; /* More distinct zebra stripe */
        }

        /* —— Base Styles —— */
        * {
            box-sizing: border-box;
            transition: background-color var(--transition),
                color var(--transition), border-color var(--transition), box-shadow var(--transition); /* Added box-shadow to transition */
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
                Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            font-size: 16px;
            line-height: 1.7;
            color: var(--text);
            background-color: var(--bg);
            display: flex; /* Use flexbox for main layout */
            height: 100vh;
            overflow: hidden; /* Hide overflow on body to manage scrolling on #content */
        }

        /* —— Sidebar —— */
        #sidebar {
            position: fixed; /* Keep fixed position */
            top: 0;
            left: 0;
            bottom: 0;
            width: 260px; /* Fixed width sidebar */
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1.5rem 1rem;
            flex-shrink: 0; /* Prevent sidebar from shrinking in flex layout */
            z-index: 500; /* Ensure sidebar is above content but below fixed buttons */
            box-shadow: 2px 0 5px rgba(0,0,0,0.05); /* Subtle shadow for sidebar */
        }

        #navList {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #navList li {
            margin: 0.6rem 0;
        }

        /* Style for all links in the nav */
        #navList a {
            display: block;
            text-decoration: none;
            color: var(--link); /* Default link color */
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-weight: 500;
            word-wrap: break-word; /* Ensure long text wraps */
            transition: background-color var(--transition), color var(--transition); /* Added color transition */
        }

        /* Style for folder links (top level within a folder group) */
        #navList li > a:first-child:not(.folder) {
                color: var(--text); /* Folder link text color same as body text */
                font-weight: 600; /* Make folder links bolder */
        }

        /* Style for nested list links (二级列表) */
        #navList ul li a {
                color: var(--link); /* Apply the standard link color (blue) */
                font-weight: 500; /* Standard font weight for nested links */
        }


        #navList a:hover {
            background-color: var(--active-bg);
            color: var(--link-hover);
        }

        #navList a.active {
            background-color: var(--active-bg);
            color: var(--link-hover);
            font-weight: 700;
            box-shadow: inset 3px 0 0 0 var(--link); /* Highlight bar on the left */
            padding-left: calc(0.8rem - 3px); /* Adjust padding to compensate for the bar */
        }

        #navList ul {
            margin-left: 1.2rem;
            padding-left: 0.5rem;
            border-left: 1px solid var(--sidebar-border);
        }
            #navList ul li {
                margin: 0.4rem 0;
            }

        .maintainer {
            margin-top: auto; /* Pushes the element to the bottom */
            padding-top: 1.5rem;
            font-size: 1.2rem; /* Slightly reduced font size */
            color: var(--footer-text);
            text-align: left;
            padding-left: 0.8rem;
            font-family: 'Great Vibes', cursive; /* Apply Great Vibes font */
            font-weight: 700; /* Make it bold */
        }

        /* —— Theme Toggle Button —— */
        #themeToggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000; /* Ensure it's on top */
            border: 1px solid var(--sidebar-border);
            background-color: var(--sidebar-bg);
            color: var(--text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
        }

        #themeToggle:hover {
            background-color: var(--code-bg);
            border-color: var(--link);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        #themeToggle:active {
                transform: scale(0.95);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* —— Back Button —— */
        #backButton {
            position: fixed;
            top: 3rem; /* Moved down to avoid overlap */
            left: calc(260px + 1rem); /* Position to the right of the sidebar + 1rem margin */
            z-index: 1000; /* Ensure it's on top */
            border: 1px solid var(--sidebar-border);
            background-color: var(--sidebar-bg);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle shadow */
        }

        #backButton:hover {
            background-color: var(--code-bg);
            border-color: var(--link);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
            #backButton:active {
                transform: scale(0.95);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }


        /* —— Content Area (Full width next to sidebar, handles scrolling) —— */
        #content {
            flex-grow: 1; /* Allow content to grow and fill space */
            overflow-y: auto; /* Add scrollbar to this area */
            padding: 0; /* Remove padding here, apply to wrapper */
            margin-left: 260px; /* Push content area next to sidebar */
            /* Add some padding-right to prevent scrollbar from overlapping content */
            padding-right: 1rem;
        }

        /* —— Badges Container (Directly added to HTML) —— */
        #topBadges {
            display: flex;
            justify-content: flex-start;
            align-items: flex-start; /* Changed from center to flex-start for top alignment */
            gap: 0.5rem; /* Added small gap between badges */
            margin: 1.5em auto; /* Centered horizontally */
            width: 70%; /* Matches content-wrapper width */
            max-width: 70%;
            padding: 0 2.5rem;
            box-sizing: border-box;
            align-self: flex-start;
        }

        /* All images within topBadges will now maintain their natural aspect ratio */
        #topBadges img {
                max-width: 100%; /* Ensure images don't overflow their container */
                height: auto; /* Allow height to adjust based on aspect ratio */
                width: auto; /* Allow width to adjust based on aspect ratio */
                display: inline-block; /* Keep inline-block or flex item behavior */
                margin: 0; /* Remove individual margins as gap handles spacing */
                border-radius: 4px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                background-color: transparent;
                /* vertical-align: top; Removed, as align-items: flex-start handles this for flex items */
        }

        /* Specific style for the IEEE badge - now follows general img rules for height/width */
        #ieee-badge {
            /* No specific height or width needed here; it will scale naturally */
            /* No need for margin here, gap property on #topBadges handles it */
        }

        #topBadges a {
                text-decoration: none;
        }


        /* —— Content Wrapper (Centers content within #content) —— */
        .content-wrapper {
            max-width: 70%;
            width: 100%;
            margin: 0 auto;
            padding: 0 2.5rem;
            padding-top: 0;
            padding-bottom: 2rem;
            box-sizing: border-box;
            flex-shrink: 0;
            align-self: center;
        }

        /* —— Table of Contents Styling —— */
        .content-wrapper ol:first-of-type,
        .content-wrapper ul:first-of-type {
                list-style: none;
                padding-left: 0;
                margin-top: 1.5em;
                margin-bottom: 2em;
                background-color: var(--code-bg);
                border: 1px solid var(--code-border);
                border-radius: 8px;
                padding: 1.5em;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .content-wrapper ol:first-of-type ul,
        .content-wrapper ul:first-of-type ul {
                margin-top: 0.5em;
                margin-bottom: 0.5em;
                padding-left: 1.5em;
                border-left: 2px solid var(--sidebar-border);
        }

        .content-wrapper ol:first-of-type li,
        .content-wrapper ul:first-of-type li {
                margin-bottom: 0.8em;
                line-height: 1.4;
                position: relative;
                padding-left: 1.2em;
        }

            .content-wrapper ol:first-of-type ul li,
            .content-wrapper ul:first-of-type ul li {
                margin-bottom: 0.4em;
            }

        /* Custom marker for ToC list items */
        .content-wrapper ol:first-of-type li::before,
        .content-wrapper ul:first-of-type li::before {
                content: "➤";
                color: var(--link);
                position: absolute;
                left: 0;
                top: 0.1em;
                font-size: 0.8em;
                font-weight: bold;
        }
            .content-wrapper ol:first-of-type ul li::before,
            .content-wrapper ul:first-of-type ul li::before {
                content: "•";
                color: var(--footer-text);
                font-size: 1em;
                top: 0.2em;
            }

        .content-wrapper li a {
                font-weight: 400;
                text-decoration: none;
                color: var(--text);
                transition: color var(--transition);
        }

        .content-wrapper li a:hover {
                color: var(--link);
                text-decoration: underline;
        }

        /* Style for the ToC heading (if it's an h2) */
        .content-wrapper h2:first-of-type {
                margin-top: 0;
                margin-bottom: 1.5em;
                border-bottom: none;
                padding-bottom: 0;
                font-size: 1.6em;
                color: var(--text);
        }

        /* —— Headings —— */
        .content-wrapper h1,
        .content-wrapper h2,
        .content-wrapper h3,
        .content-wrapper h4,
        .content-wrapper h5,
        .content-wrapper h6 {
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 600;
            line-height: 1.3;
        }

        .content-wrapper h1 {
            font-size: 2.2em;
            border-bottom: 1px solid var(--sidebar-border);
            padding-bottom: 0.4em;
        }

        .content-wrapper h2 {
            font-size: 1.8em;
                border-bottom: 1px dashed var(--sidebar-border);
                padding-bottom: 0.3em;
        }
        .content-wrapper h3 {
                font-size: 1.4em;
        }

        /* —— Paragraphs —— */
        .content-wrapper p {
            margin: 0 0 1.2em 0;
        }

        /* —— Code & Preformatted Blocks —— */
        .content-wrapper pre {
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            padding: 1.2rem;
            border-radius: 8px;
            position: relative;
            overflow-x: auto;
            margin: 1.5em 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow for code blocks */
        }

        .content-wrapper code:not(pre code) { /* Inline code */
            background-color: var(--code-bg);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid var(--code-border);
        }
        .content-wrapper pre code { /* Code within pre blocks */
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.95em;
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 5px;
            cursor: pointer;
            opacity: 0.7;
            transition: background-color var(--transition), color var(--transition), opacity 0.15s ease;
        }
        .content-wrapper pre:hover .copy-btn {
                opacity: 1;
        }

        .copy-btn:hover {
            background: var(--btn-hover);
            opacity: 1;
        }
        .copy-btn.copied {
                background: #28a745;
                color: white;
        }

        /* —— Links, Tables, Blockquotes —— */
        .content-wrapper a {
            color: var(--link);
            text-decoration: none;
        }

        .content-wrapper a:hover {
            text-decoration: underline;
            color: var(--link-hover);
        }

        .content-wrapper table {
            border-collapse: collapse;
            width: 100%;
            margin: 1.8em 0;
            box-shadow: 0 2px 4px var(--img-shadow);
            border-radius: 6px;
            overflow: hidden;
        }

        .content-wrapper th,
        .content-wrapper td {
            border: 1px solid var(--table-border);
            padding: 0.8em 1.2em;
            text-align: left;
        }
        .content-wrapper th {
                background-color: var(--table-header-bg);
                font-weight: 600;
        }
        .content-wrapper tr:nth-child(even) {
                background-color: var(--table-row-even-bg);
        }

        .content-wrapper blockquote {
            border-left: 5px solid var(--link);
            padding: 1em 1.5em;
            margin: 1.8em 0;
            background-color: var(--code-bg);
            border-radius: 0 6px 6px 0;
            color: var(--footer-text);
        }
        .content-wrapper blockquote p:last-child {
                margin-bottom: 0;
        }

        /* —— Images (including SVG) —— */
        .content-wrapper img {
            max-width: 60%;
            height: auto;
            display: block;
            margin: 1.5em auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--img-shadow);
            background-color: var(--bg);
        }

        /* —— Key Contributions List Styling —— */
        .content-wrapper ul:not(:first-of-type) {
                list-style: none;
                padding-left: 1.5em;
                margin-top: 1.5em;
                margin-bottom: 1.5em;
        }

            .content-wrapper ul:not(:first-of-type) li {
                margin-bottom: 0.8em;
                position: relative;
            }

            /* Custom marker for Key Contributions list items */
            .content-wrapper ul:not(:first-of-type) li::before {
                content: "→";
                color: var(--link);
                position: absolute;
                left: -1.5em;
                top: 0.1em;
                font-weight: bold;
            }

            /* Responsive adjustments */
        @media (max-width: 768px) {
                #sidebar {
                    width: 200px; /* Slightly reduce sidebar width on smaller screens */
                    padding: 1rem 0.8rem;
                }
                #backButton {
                    left: calc(200px + 0.8rem); /* Adjust back button position */
                    top: 1rem; /* Move back button closer to top on mobile */
                    padding: 0.3rem 0.8rem;
                    font-size: 14px;
                }
                #themeToggle {
                    top: 0.8rem;
                    right: 0.8rem;
                    width: 35px;
                    height: 35px;
                    font-size: 18px;
                }
                #content {
                    margin-left: 200px; /* Adjust content margin */
                    padding-right: 0.5rem;
                }
                .content-wrapper {
                    max-width: 95%; /* Allow content to take more width */
                    padding: 0 1rem;
                }
                .content-wrapper img {
                    max-width: 90%; /* Allow images to be larger */
                }
                .maintainer {
                    font-size: 1rem; /* Further reduce maintainer font size */
                    padding-left: 0.5rem;
                }
                .content-wrapper h1 {
                    font-size: 1.8em;
                }
                .content-wrapper h2 {
                    font-size: 1.5em;
                }
                .content-wrapper h3 {
                    font-size: 1.2em;
                }
                .content-wrapper pre {
                    padding: 0.8rem;
                }
                .content-wrapper table th,
                .content-wrapper table td {
                    padding: 0.5em 0.8em;
                }
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav id="sidebar">
        <div class="nav-container">
            <ul id="navList">
                <li><a href="#README.md">Home</a></li>
                <li>
                    <!-- Link to external GitHub folder for Backbone -->
                    <a href="https://github.com/rekkles2/Fed_WSVAD/tree/main/Backbone" target="_blank" rel="noopener noreferrer">Backbone</a>
                    <ul>
                        <!-- Internal link to a Markdown file within the Backbone folder -->
                        <li><a href="#Backbone/README.md">Feature Extraction Guide (VideoMAE V2 Backbone)</a></li>
                    </ul>
                </li>
                <li>
                    <!-- Link to external GitHub folder for Fed-VAD -->
                    <a href="https://github.com/rekkles2/Fed_WSVAD/tree/main/Fed_VAD" target="_blank" rel="noopener noreferrer">Fed-VAD</a>
                    <ul>
                        <!-- Internal links to Markdown files within the Fed_VAD folder -->
                        <li><a href="#Fed_VAD/Jetson%20AGX%20Xavier%20Deployment%20Guide.md">Jetson AGX Xavier Deployment Guide</a></li>
                        <li><a href="#Fed_VAD/README.md">Federated Setup (Fed-WSVAD)</a></li>
                    </ul>
                </li>
                <!-- External link to DeepWiki Code Navigator -->
                <li><a href="https://deepwiki.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer">DeepWiki Code Navigator</a></li>
            </ul>
        </div>
        <!-- Maintainer information at the bottom of the sidebar -->
        <div class="maintainer">Maintained by Jiahang Li</div>
    </nav>

    <!-- Theme Toggle Button (Moon/Sun icon) -->
    <button id="themeToggle" aria-label="Toggle dark/light mode">🌙</button>
    <!-- Back Button for navigation history -->
    <button id="backButton">← Back</button>

    <!-- Main Content Area -->
    <main id="content">
        <!-- Top Badges Section (Dynamically loaded project badges) -->
        <div id="topBadges">
            <a href="https://ieeexplore.ieee.org/document/11036561" target="_blank" rel="noopener noreferrer" title="IEEE TII Paper on IEEE Xplore">
                <img id="ieee-badge" src="https://img.shields.io/badge/IEEE%20TII-Paper-0050FF?style=flat-square&logo=ieee&logoColor=white" alt="IEEE TII Paper"/>
            </a>
            <!-- Updated Appendix Badge -->
            <a href="https://rekkles2.github.io/Fed_WSVAD/Figure/Appendix.pdf" target="_blank" rel="noopener noreferrer" title="Supplementary Appendix (PDF)">
                <img src="https://img.shields.io/badge/%F0%9F%93%84%20Appendix-PDF-6c757d?style=flat-square&logo=adobeacrobatreader&logoColor=white" alt="Appendix PDF"/>
            </a>
            <a href="https://github.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer" title="GitHub Repository Stars">
                <img src="https://img.shields.io/github/stars/rekkles2/Fed_WSVAD?style=flat-square&logo=github&logoColor=white&color=FFD700" alt="GitHub Stars"/>
            </a>
            <a href="https://github.com/rekkles2/Fed_WSVAD/fork" target="_blank" rel="noopener noreferrer" title="GitHub Repository Forks">
                <img src="https://img.shields.io/github/forks/rekkles2/Fed_WSVAD?style=flat-square&logo=github&logoColor=white&color=orange" alt="GitHub Forks"/>
            </a>
            <a href="https://rekkles2.github.io/Fed_WSVAD/#README.md" target="_blank" rel="noopener noreferrer" title="Project Home Page">
                <img src="https://img.shields.io/badge/%F0%9F%8C%90-Project%20Page-0084FF?style=flat-square" alt="Project Page"/>
            </a>
            <a href="https://github.com/rekkles2/Fed_WSVAD/blob/main/LICENSE" target="_blank" rel="noopener noreferrer" title="Apache 2.0 License">
                <img src="https://img.shields.io/github/license/rekkles2/Fed_WSVAD?style=flat-square&logo=apache&logoColor=white&color=brightgreen" alt="License"/>
            </a>
        </div>
        <!-- Content Wrapper for Markdown content -->
        <div class="content-wrapper">
            <p>Loading...</p>
        </div>
    </main>

    <!-- Clustrmaps visitor counter (external script) -->
    <div id="clustrmaps-container">
        <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=a&t=tt&d=5vXVLxUQJKZmhtb1zgYwBSdr65TUyHOP2wBiSDJj2Os'></script>
    </div>

    <!-- JavaScript Libraries -->
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script>
        // --- Theme Toggle Functionality ---
        const themeToggleBtn = document.getElementById('themeToggle');
        const lightStyle = document.getElementById('hljs-light');
        const darkStyle = document.getElementById('hljs-dark');
        const savedTheme = localStorage.getItem('theme');

        /**
         * Applies the specified theme to the document.
         * @param {string} theme - 'light' or 'dark'.
         */
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark');
                // Disable light theme stylesheet and enable dark theme stylesheet for highlight.js
                if (lightStyle) lightStyle.disabled = true;
                if (darkStyle) darkStyle.disabled = false; // Corrected: should be enabled for dark mode
                themeToggleBtn.textContent = '☀️'; // Sun icon for dark mode
            } else {
                document.body.classList.remove('dark');
                // Enable light theme stylesheet and disable dark theme stylesheet for highlight.js
                if (lightStyle) lightStyle.disabled = false;
                if (darkStyle) darkStyle.disabled = true;
                themeToggleBtn.textContent = '🌙'; // Moon icon for light mode
            }
        }

        // Apply saved theme or system preference on load
        applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

        // Event listener for theme toggle button
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // --- Markdown Loading and Processing ---
        const contentDiv = document.getElementById('content');
        const contentWrapperDiv = contentDiv.querySelector('.content-wrapper');
        let currentFile = null; // Tracks the currently loaded markdown file
        // Base URL for raw content from the GitHub repository
        const GITHUB_REPO_RAW_BASE_URL = 'https://raw.githubusercontent.com/rekkles2/Fed_WSVAD/main/';
        // Special URL for the home README, which might be in a different repo/branch
        const HOME_README_URL = 'https://raw.githubusercontent.com/rekkles2/page/main/README.md';


        /**
         * Generates a valid HTML ID from a string, suitable for heading anchors.
         * Converts text to lowercase, replaces invalid characters with hyphens, and trims hyphens.
         * @param {string} input - The string to convert.
         * @returns {string} - A valid HTML ID.
         */
        function generateValidId(input) {
            // Replace invalid characters with hyphens, remove leading/trailing hyphens
            return input.trim().toLowerCase()
                                .replace(/[^\w\s-]/g, '')
                                .replace(/\s+/g, '-')
                                .replace(/-+/g, '-')
                                .replace(/^-+|-+$/g, '');
        }

        /**
         * Fetches and renders Markdown content into the main content area.
         * Handles internal and external link rewriting, code highlighting, and copy buttons.
         * @param {string} filePath - The path to the Markdown file (e.g., 'README.md', 'Backbone/README.md').
         */
        async function loadMarkdown(filePath) {
            // Clear previous content and display loading message
            contentWrapperDiv.innerHTML = '<p>Loading content...</p>';

            try {
                // Determine the correct URL for the markdown file
                const isHomePage = filePath === 'README.md';
                const fileUrl = isHomePage ? HOME_README_URL : GITHUB_REPO_RAW_BASE_URL + filePath;
                const response = await fetch(fileUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} for ${fileUrl}`);
                }
                const markdownText = await response.text();

                // Parse Markdown to HTML using 'marked' library
                let parsedHtml = marked.parse(markdownText);

                // Insert parsed markdown into the content wrapper
                contentWrapperDiv.innerHTML = parsedHtml;


                // --- Link Handling ---
                // Determine the base URL for resolving relative links within the current markdown file
                const currentFileDirectory = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/') + 1) : '';
                const baseUrlForRelativeLinks = (isHomePage) ?
                                                        new URL(HOME_README_URL).href.substring(0, new URL(HOME_README_URL).href.lastIndexOf('/') + 1) : // Base of the 'page' repo
                                                        new URL(currentFileDirectory, GITHUB_REPO_RAW_BASE_URL).href;

                // After inserting HTML, find all links and headings to correct internal links
                const headings = contentWrapperDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
                const links = contentWrapperDiv.querySelectorAll('a');

                // Generate IDs for headings if they don't have them
                headings.forEach(heading => {
                    if (!heading.id) {
                            heading.id = generateValidId(heading.textContent.trim());
                    }
                });

                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href) {
                        // Handle relative links (not starting with #, http, mailto)
                        if (!href.startsWith('#') && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('mailto:')) {
                            const parts = href.split('#');
                            const pathPart = parts[0];
                            const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';

                            if (pathPart.toLowerCase().endsWith('.md')) {
                                // Convert relative .md links to internal hash links for SPA navigation
                                let absolutePath;
                                // Resolve relative path based on the current markdown file's directory
                                absolutePath = new URL(pathPart, baseUrlForRelativeLinks).pathname;
                                // Make path relative to GITHUB_REPO_RAW_BASE_URL's path part if it's not the home page
                                if (!isHomePage) {
                                    let baseRepoPath = new URL(GITHUB_REPO_RAW_BASE_URL).pathname;
                                    if (absolutePath.startsWith(baseRepoPath)) {
                                        absolutePath = absolutePath.substring(baseRepoPath.length);
                                    }
                                }
                                absolutePath = absolutePath.replace(/^\//, ''); // Ensure no leading slash for hash

                                link.setAttribute('href', `#${absolutePath}${internalHashPart}`); // Use original path in hash

                            } else {
                                // Convert other relative links (assets, etc.) to absolute raw GitHub URLs
                                const absoluteUrl = new URL(href, baseUrlForRelativeLinks).href;
                                link.setAttribute('href', absoluteUrl);
                                link.setAttribute('target', '_blank'); // Open asset links in new tab
                                link.setAttribute('rel', 'noopener noreferrer');
                            }
                        } else if (href.startsWith('https://github.com/rekkles2/Fed_WSVAD/blob/main/')) {
                            // Convert GitHub blob links to internal hash links
                            const repoPathWithHash = href.substring('https://github.com/rekkles2/Fed_WSVAD/blob/main/'.length);
                            const parts = repoPathWithHash.split('#');
                            const pathPart = parts[0];
                            const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';
                            link.setAttribute('href', `#${pathPart}${internalHashPart}`);
                        } else if (href.startsWith('#') && href.length > 1) {
                                // It's an internal page hash link (e.g., #section)
                                const originalSectionId = href.substring(1); // Get the original section ID from Markdown

                                // Try to find a heading element whose generated ID matches the original section ID
                                // Convert NodeList to Array to use find() method
                                const headingsArray = Array.from(headings);
                                let targetElement = headingsArray.find(heading => generateValidId(heading.textContent.trim()) === generateValidId(originalSectionId));

                                // Fallback: If finding by generated ID of heading text fails,
                                // try finding by the exact originalSectionId from the link's href.
                                // This is necessary because Markdown parsers might generate IDs differently
                                // for list items compared to headings.
                                if (!targetElement) {
                                        targetElement = contentWrapperDiv.querySelector(`#${originalSectionId}`);
                                }

                                // Final fallback: Try to find an element whose text content closely matches the link text
                                if (!targetElement) {
                                        const linkText = link.textContent.trim();
                                        if (linkText) {
                                            // Look for any element that might contain this text and is a potential target
                                            // This is a broad search and might need refinement based on actual HTML structure
                                            // We'll try to find a heading with matching text content first
                                            targetElement = headingsArray.find(heading => heading.textContent.trim() === linkText);

                                            // If not found in headings, try a broader search within the content wrapper
                                            if (!targetElement) {
                                                targetElement = contentWrapperDiv.querySelector(`*:has(a[href="${href}"])`); // Find the parent element of the link
                                                if (targetElement && targetElement !== link.parentElement) {
                                                        // If the parent is found and it's not just the link itself,
                                                        // try to find a heading or other block element within it
                                                        targetElement = targetElement.querySelector('h1, h2, h3, h4, h5, h6, p, div'); // Broad search
                                                }
                                            }
                                            // As a last resort, try finding any element with a matching generated ID from the link text
                                            if (!targetElement) {
                                                    const generatedIdFromLinkText = generateValidId(linkText);
                                                    targetElement = contentWrapperDiv.querySelector(`#${generatedIdFromLinkText}`);
                                            }
                                        }
                                }


                                if (targetElement && targetElement.id) {
                                        // If a target element with an ID is found, update the link href to point to its ID
                                        link.setAttribute('href', `#${filePath}#${targetElement.id}`); // Format: #FilePath.md#target-id
                                } else {
                                    console.warn(`Could not find a reliable target element for internal link: ${href} in ${filePath}. Link text: "${link.textContent.trim()}"`);
                                        // If target not found, modify to a potentially invalid hash that includes the file path
                                        link.setAttribute('href', `#${filePath}${href}`); // Keep original hash part but add file path
                                }
                        }

                                // Ensure all external HTTP/HTTPS links open in a new tab
                                if ((href.startsWith('http://') || href.startsWith('https://')) && !link.getAttribute('href').startsWith('#')) {
                                    // Check if it's not already targeting _blank and not an internal SPA link
                                    if (link.getAttribute('target') !== '_blank') {
                                        try {
                                            const linkUrl = new URL(link.href); // Use link.href to get absolute URL
                                            const currentLocUrl = new URL(window.location.href);
                                            if (linkUrl.hostname !== currentLocUrl.hostname || linkUrl.protocol !== currentLocUrl.protocol) {
                                                link.setAttribute('target', '_blank');
                                                link.setAttribute('rel', 'noopener noreferrer');
                                            }
                                        } catch (e) {
                                            console.error("Error processing link URL for target='_blank':", href, e);
                                            // Fallback for potentially malformed relative links that became absolute
                                            if (!link.href.startsWith(`${window.location.origin}`)) {
                                                link.setAttribute('target', '_blank');
                                                link.setAttribute('rel', 'noopener noreferrer');
                                            }
                                        }
                                    }
                                }
                    }
                });

                // Highlight code blocks after content is loaded
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // Add copy buttons to code blocks
                document.querySelectorAll('pre').forEach(pre => {
                    const button = document.createElement('button');
                    button.className = 'copy-btn';
                    button.textContent = 'Copy';
                    pre.appendChild(button);

                    button.addEventListener('click', async () => {
                        const code = pre.querySelector('code').textContent;
                        try {
                            // Using Clipboard API, fallback to execCommand if not supported (e.g., in some iframes)
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(code);
                            } else {
                                const textarea = document.createElement('textarea');
                                textarea.value = code;
                                textarea.style.position = 'fixed'; // Avoid scrolling to bottom
                                document.body.appendChild(textarea);
                                textarea.focus();
                                textarea.select();
                                document.execCommand('copy'); // Deprecated but widely supported fallback
                                document.body.removeChild(textarea);
                            }
                            button.textContent = 'Copied!';
                            button.classList.add('copied');
                            setTimeout(() => {
                                button.textContent = 'Copy';
                                button.classList.remove('copied');
                            }, 2000);
                        } catch (err) {
                            console.error('Failed to copy text: ', err);
                            button.textContent = 'Failed!';
                        }
                    });
                });

                // Scroll to target heading if hash exists in the URL
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1); // Remove leading #
                    const parts = hash.split('#'); // Split by # to get file and target ID
                    const targetFile = parts[0];
                    const targetId = parts.length > 1 ? parts[1] : null;

                    if (targetFile === filePath && targetId) {
                        const targetElement = document.getElementById(targetId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                }

                currentFile = filePath; // Update current file tracker
                updateSidebarActiveState(currentFile); // Update sidebar active state
            } catch (error) {
                console.error('Failed to load markdown:', error);
                contentWrapperDiv.innerHTML = `<p style="color: red;">Error loading content. Please try again later. <br/> Details: ${error.message}</p>`;
            }
        }

        // --- Sidebar Navigation ---
        const navList = document.getElementById('navList');

        /**
         * Updates the 'active' class on sidebar navigation links based on the currently loaded file.
         * @param {string} filePath - The path of the Markdown file currently displayed.
         */
        function updateSidebarActiveState(filePath) {
            navList.querySelectorAll('a').forEach(link => {
                let linkHref = link.getAttribute('href');
                if (linkHref && linkHref.startsWith('#')) {
                    // Extract the base file path from the sidebar link's hash
                    // Example: #Backbone/README.md or #README.md
                    let sidebarFilePath = linkHref.substring(1).split('#')[0]; // Get 'Backbone/README.md' or 'README.md'
                    if (sidebarFilePath.endsWith('/')) { // Handle folder links like #Backbone/
                        sidebarFilePath = sidebarFilePath.slice(0, -1);
                    }

                    // Normalize the current displayed file path for comparison
                    let normalizedCurrentFilePath = filePath;
                    if (normalizedCurrentFilePath.endsWith('/')) {
                        normalizedCurrentFilePath = normalizedCurrentFilePath.slice(0, -1);
                    }

                    if (normalizedCurrentFilePath === sidebarFilePath) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                } else if (linkHref && (linkHref.startsWith('http://') || linkHref.startsWith('https://'))) {
                    // For external links in sidebar, ensure they open in new tab
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                }
            });
        }

        // Event listener for sidebar clicks (SPA navigation)
        navList.addEventListener('click', (event) => {
            const targetLink = event.target.closest('a');
            if (targetLink && targetLink.getAttribute('href').startsWith('#')) {
                event.preventDefault(); // Prevent default link behavior for internal links
                const hash = targetLink.getAttribute('href').substring(1);
                // The hash format is expected to be `FilePath.md#target-id` or just `FilePath.md`
                const parts = hash.split('#');
                const filePath = parts[0];
                const sectionId = parts.length > 1 ? parts[1] : null;

                // Update URL hash without reloading the page
                window.history.pushState({}, '', `#${filePath}${sectionId ? '#' + sectionId : ''}`);

                // Load the markdown content
                loadMarkdown(filePath).then(() => {
                    // After loading the file, scroll to the section if an ID exists
                    if (sectionId) {
                        const targetElement = document.getElementById(sectionId);
                        if (targetElement) {
                            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    } else {
                        // If no specific section, scroll to top of the content
                        contentDiv.scrollTop = 0;
                    }
                });
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const parts = hash.split('#');
                const filePath = parts[0];
                const sectionId = parts.length > 1 ? parts[1] : null;
                if (filePath) {
                    loadMarkdown(filePath).then(() => {
                        if (sectionId) {
                            const targetElement = document.getElementById(sectionId);
                            if (targetElement) {
                                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }
                    });
                }
            } else {
                // If hash is empty, load the home README
                loadMarkdown('README.md');
            }
        });

        // --- Back Button Functionality ---
        const backButton = document.getElementById('backButton');
        backButton.addEventListener('click', () => {
            window.history.back(); // Use browser history to go back
        });


        // Initial content load based on URL hash or default to README.md
        const initialHash = window.location.hash.substring(1);
        if (initialHash) {
            const parts = initialHash.split('#');
            loadMarkdown(parts[0]);
        } else {
            loadMarkdown('README.md'); // Load default home page
        }

    </script>
</body>
</html>
