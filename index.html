<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fed_WSVAD Documentation</title>
  <link id="hljs-light" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" />
  <link id="hljs-dark" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"
    disabled />
  <style>
    /* —— Color Variables —— */
    :root {
      --bg: #ffffff;
      --text: #24292e;
      --sidebar-bg: #fdfdfd;
      --sidebar-border: #e1e4e8;
      --link: #0366d6;
      --link-hover: #024ea2;
      --active-bg: #e7f4ff; /* A slightly lighter blue for active items */
      --code-bg: #f6f8fa;
      --code-border: #e1e4e8;
      --btn-bg: #0366d6;
      --btn-text: #ffffff;
      --btn-hover: #024ea2;
      --footer-text: #57606a;
      --transition: 0.2s ease-in-out;
      --img-shadow: rgba(0,0,0,0.1);

      /* Table Specific Colors (New/Adjusted) */
      --table-border: #c6cbd1; /* Darker border for tables */
      --table-header-bg: #f0f3f6; /* Slightly darker header background */
      --table-row-even-bg: #f6f8fa; /* Slightly darker zebra stripe */
    }

    body.dark {
      --bg: #0d1117;
      --text: #c9d1d9;
      --sidebar-bg: #161b22;
      --sidebar-border: #30363d;
      --link: #58a6ff;
      --link-hover: #4191db;
      --active-bg: #1f6feb33; /* A subtle blue highlight for dark mode */
      --code-bg: #161b22;
      --code-border: #30363d;
      --btn-bg: #238636;
      --btn-text: #ffffff;
      --btn-hover: #196e2d;
      --footer-text: #8b949e;
      --img-shadow: rgba(0,0,0,0.3);

      /* Table Specific Colors (Dark Mode) (New/Adjusted) */
      --table-border: #444c56; /* Darker border for tables in dark mode */
      --table-header-bg: #21262d; /* Darker header background in dark mode */
      --table-row-even-bg: #1c222b; /* Darker zebra stripe in dark mode */
    }

    /* —— Base Styles —— */
    * {
      box-sizing: border-box;
      transition: background-color var(--transition),
        color var(--transition), border-color var(--transition); /* Added border-color to transition */
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
        Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* Added emoji fonts */
      font-size: 16px;
      line-height: 1.7; /* Increased for better readability */
      color: var(--text);
      background-color: var(--bg);
      display: flex; /* Use flexbox for main layout */
      height: 100vh;
      overflow: hidden; /* Hide overflow on body to manage scrolling on #content */
    }

    /* Removed Badges Container Styles */


    /* —— Sidebar —— */
    #sidebar {
      position: fixed; /* Keep fixed position */
      top: 0;
      left: 0;
      bottom: 0;
      width: 260px; /* Fixed width sidebar */
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1.5rem 1rem; /* Adjusted padding */
      flex-shrink: 0; /* Prevent sidebar from shrinking in flex layout */
    }

    #navList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #navList li {
      margin: 0.6rem 0; /* Increased spacing between items */
    }

    #navList a, #navList .folder {
      display: block;
      text-decoration: none;
      color: var(--link);
      padding: 0.5rem 0.8rem; /* Increased padding for better touch targets */
      border-radius: 6px; /* Slightly more rounded corners */
      font-weight: 500;
      word-wrap: break-word; /* Ensure long text wraps */
    }
      #navList .folder {
        color: var(--text); /* Folder text color same as body text */
        font-weight: 600; /* Make folder names bolder */
        cursor: default;
      }


    #navList a:hover {
      background-color: var(--active-bg);
      color: var(--link-hover);
    }

    #navList a.active {
      background-color: var(--active-bg);
      color: var(--link-hover); /* Ensure text color changes for active link */
      font-weight: 700; /* Bolder active link */
    }

    #navList ul {
      margin-left: 1.2rem; /* Slightly increased indent for sub-items */
      padding-left: 0.5rem;
      border-left: 1px solid var(--sidebar-border);
    }
      #navList ul li {
        margin: 0.4rem 0;
      }

    .maintainer {
      margin-top: auto;
      padding-top: 1.5rem; /* Increased padding */
      font-size: 0.9rem; /* Slightly larger maintainer text */
      color: var(--footer-text);
      text-align: left;
    }

    /* —— Theme Toggle Button —— */
    #themeToggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      border: 1px solid var(--sidebar-border); /* Added border for definition */
      background-color: var(--sidebar-bg); /* Use sidebar background */
      color: var(--text); /* Use body text color */
      width: 40px; /* Slightly larger */
      height: 40px; /* Slightly larger */
      border-radius: 50%;
      font-size: 20px; /* Slightly larger icon */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
    }

    #themeToggle:hover {
      background-color: var(--code-bg); /* Use code background for hover */
      border-color: var(--link);
    }
    #themeToggle:active {
        transform: scale(0.95);
    }


    /* —— Content Area (Full width next to sidebar, handles scrolling) —— */
    #content {
      flex-grow: 1; /* Allow content to grow and fill space */
      overflow-y: auto; /* Add scrollbar to this area */
      padding: 0; /* Remove padding here, apply to wrapper */
      margin-left: 260px; /* Push content area next to sidebar */
      display: flex; /* Use flexbox to center the wrapper */
      justify-content: center; /* Center the wrapper horizontally */
    }

    /* —— Content Wrapper (Centers content within #content) —— */
    .content-wrapper {
      max-width: 80%; /* Limit content width to 80% of #content */
      width: 100%; /* Allow wrapper to take full width up to max-width */
      padding: 2rem 2.5rem; /* Apply padding here */
      padding-top: 2rem; /* Adjust top padding */
      /* Removed margin: 0 auto; as flexbox on #content handles centering */
    }


    .content-wrapper h1,
    .content-wrapper h2,
    .content-wrapper h3,
    .content-wrapper h4,
    .content-wrapper h5,
    .content-wrapper h6 {
      margin-top: 2em;    /* Increased top margin for headings */
      margin-bottom: 1em; /* Increased bottom margin for headings */
      font-weight: 600;
      line-height: 1.3;    /* Adjusted line-height for headings */
    }

    .content-wrapper h1 {
      font-size: 2.2em; /* Slightly larger H1 */
      border-bottom: 1px solid var(--sidebar-border);
      padding-bottom: 0.4em;
    }

    .content-wrapper h2 {
      font-size: 1.8em; /* Slightly larger H2 */
       border-bottom: 1px dashed var(--sidebar-border); /* Subtle separator for H2 */
       padding-bottom: 0.3em;
    }
    .content-wrapper h3 {
        font-size: 1.4em;
    }


    .content-wrapper p {
      margin: 0 0 1.2em 0; /* Consistent bottom margin for paragraphs */
    }

    /* —— Code & Preformatted Blocks —— */
    .content-wrapper pre {
      background-color: var(--code-bg);
      border: 1px solid var(--code-border);
      padding: 1.2rem; /* Increased padding */
      border-radius: 8px; /* More rounded corners */
      position: relative;
      overflow-x: auto;
      margin: 1.5em 0; /* Added vertical margin */
    }

    .content-wrapper code:not(pre code) { /* Inline code */
      background-color: var(--code-bg);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.9em;
      border: 1px solid var(--code-border);
    }
    .content-wrapper pre code { /* Code within pre blocks */
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; /* Common monospace stack */
      font-size: 0.95em;
      background-color: transparent; /* No background for code inside pre */
      border: none;
      padding: 0;
    }


    .copy-btn {
      position: absolute;
      top: 10px; /* Adjusted position */
      right: 10px; /* Adjusted position */
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 6px 10px; /* Adjusted padding */
      font-size: 13px; /* Adjusted font size */
      border-radius: 5px; /* Adjusted border radius */
      cursor: pointer;
      opacity: 0.7; /* Slightly transparent by default */
      transition: background-color var(--transition), color var(--transition), opacity 0.15s ease;
    }
    .content-wrapper pre:hover .copy-btn {
        opacity: 1; /* Fully visible on pre hover */
    }

    .copy-btn:hover {
      background: var(--btn-hover);
      opacity: 1;
    }
    .copy-btn.copied { /* Style for when button is clicked */
        background: #28a745; /* Green for success */
        color: white;
    }


    /* —— Links, Tables, Blockquotes —— */
    .content-wrapper a {
      color: var(--link);
      text-decoration: none; /* Remove underline by default */
    }

    .content-wrapper a:hover {
      text-decoration: underline; /* Underline on hover */
      color: var(--link-hover);
    }

    .content-wrapper table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.8em 0; /* Added vertical margin */
      box-shadow: 0 2px 4px var(--img-shadow); /* Subtle shadow for tables */
      border-radius: 6px; /* Rounded corners for table wrapper (if any) or via cells */
      overflow: hidden; /* Needed for border-radius on table */
    }

    .content-wrapper th,
    .content-wrapper td {
      border: 1px solid var(--table-border); /* Use new table border variable */
      padding: 0.8em 1.2em; /* Adjusted padding */
      text-align: left; /* Ensure text is left-aligned */
    }
    .content-wrapper th {
        background-color: var(--table-header-bg); /* Use new table header background variable */
        font-weight: 600;
    }
    .content-wrapper tr:nth-child(even) {
        background-color: var(--table-row-even-bg); /* Use new zebra stripe background variable */
    }


    .content-wrapper blockquote {
      border-left: 5px solid var(--link); /* Use link color for border */
      padding: 1em 1.5em; /* Adjusted padding */
      margin: 1.8em 0; /* Adjusted margin */
      background-color: var(--code-bg);
      border-radius: 0 6px 6px 0; /* Rounded corners on one side */
      color: var(--footer-text); /* Softer text color for blockquotes */
    }
    .content-wrapper blockquote p:last-child {
        margin-bottom: 0; /* Remove bottom margin from last p in blockquote */
    }

    /* —— Images (including SVG) —— */
    .content-wrapper img {
      max-width: 40%; /* Limit images to 40% of its container width */
      height: auto;
      display: block;
      margin: 1.5em auto; /* Centered with vertical margin */
      border-radius: 8px; /* Rounded corners for images */
      box-shadow: 0 4px 12px var(--img-shadow); /* Softer, more diffused shadow */
      background-color: var(--bg); /* Add background for transparent images */
    }

  </style>
</head>
<body>
  <nav id="sidebar">
    <div class="nav-container">
      <ul id="navList">
        <li><a href="#README.md">Home</a></li>
        <li><span class="folder">Backbone</span>
          <ul>
            <li><a href="#Backbone/README.md">Feature Extraction Guide (VideoMAE V2 Backbone)</a></li>
          </ul>
        </li>
        <li><span class="folder">Fed_VAD</span>
          <ul>
            <li><a href="#Fed_VAD/README.md">Federated Setup (Fed-WSVAD)</a></li>
            <li><a href="#Fed_VAD/Jetson%20AGX%20Xavier%20Deployment%20Guide.md">Jetson AGX Xavier Deployment Guide</a></li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="maintainer">Maintained by Jiahang Li</div>
  </nav>

  <button id="themeToggle" aria-label="Toggle dark/light mode">🌙</button>

  <main id="content">
    <div class="content-wrapper">
      <p>Loading...</p>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script>
    const themeToggleBtn = document.getElementById('themeToggle');
    const lightStyle = document.getElementById('hljs-light');
    const darkStyle = document.getElementById('hljs-dark');
    const savedTheme = localStorage.getItem('theme');

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        if (lightStyle) lightStyle.disabled = true;
        if (darkStyle) darkStyle.disabled = false;
        themeToggleBtn.textContent = '☀️';
      } else {
        document.body.classList.remove('dark');
        if (lightStyle) lightStyle.disabled = false;
        if (darkStyle) darkStyle.disabled = true;
        themeToggleBtn.textContent = '🌙';
      }
    }

    applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });

    const contentDiv = document.getElementById('content');
    const contentWrapperDiv = contentDiv.querySelector('.content-wrapper'); // Get the new wrapper div
    let currentFile = null;
    const GITHUB_REPO_RAW_BASE_URL = 'https://raw.githubusercontent.com/rekkles2/Fed_WSVAD/main/';

    // Function to generate a valid HTML ID from a string (e.g., heading text)
    function generateValidId(input) {
        // Replace invalid characters with hyphens
        return input.trim().toLowerCase()
                   .replace(/[^\w\s-]/g, '') // Remove non-alphanumeric (except hyphen, underscore)
                   .replace(/\s+/g, '-') // Replace spaces with hyphens
                   .replace(/-+/g, '-'); // Replace multiple hyphens with single
    }


    async function loadMarkdown(filePath) {
      contentWrapperDiv.innerHTML = '<p>Loading content...</p>'; // Load message inside the wrapper
      try {
        const response = await fetch(GITHUB_REPO_RAW_BASE_URL + filePath);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} for ${filePath}`);
        }
        let markdownText = await response.text();

        // Parse markdown first
        let parsedHtml = marked.parse(markdownText);

        // Insert parsed markdown into the content wrapper
        contentWrapperDiv.innerHTML = parsedHtml;


        // --- Link Handling ---
        const currentFileDirectory = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/') + 1) : '';
        const baseUrl = new URL(currentFileDirectory, GITHUB_REPO_RAW_BASE_URL).href; // Base URL for resolving relative links

        contentWrapperDiv.querySelectorAll('a').forEach(link => {
            const href = link.getAttribute('href');
            if (href) {
                // Check if it's a relative link (not starting with #, http, mailto)
                if (!href.startsWith('#') && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('mailto:')) {
                    // Split href into path and potential hash
                    const parts = href.split('#');
                    const pathPart = parts[0];
                    const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : ''; // Rejoin multiple hashes if any

                    if (pathPart.toLowerCase().endsWith('.md')) {
                        // It's a relative .md link - convert to hash link using original file path
                        const absolutePath = new URL(pathPart, baseUrl).pathname.substring(1); // Resolve absolute path
                        link.setAttribute('href', '#' + absolutePath + internalHashPart); // Use original path in hash
                    } else {
                        // It's another relative link (asset, etc.) - convert to absolute raw URL
                         const absoluteUrl = new URL(href, baseUrl).href; // Resolve absolute URL
                         link.setAttribute('href', absoluteUrl);
                         link.setAttribute('target', '_blank'); // Open external links in new tab
                    }
                } else if (href.startsWith('https://github.com/rekkles2/Fed_WSVAD/blob/main/')) {
                     // Handle existing GitHub blob links - convert to hash link using repo path
                     const repoPathWithHash = href.substring('https://github.com/rekkles2/Fed_WSVAD/blob/main/'.length);
                     const parts = repoPathWithHash.split('#');
                     const pathPart = parts[0];
                     const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';
                     link.setAttribute('href', '#' + pathPart + internalHashPart); // Use original repo path in hash
                } else if (href.startsWith('#') && href.length > 1) {
                    // It's an internal page hash link (e.g., #section)
                    // No change to href needed here. Scrolling will use querySelector with the valid ID generated from text.
                }

                 // For external http/https links, add target="_blank"
                if (href.startsWith('http://') || href.startsWith('https://')) {
                    // Check if it's an external link (not to the current domain)
                    try {
                        const linkUrl = new URL(href);
                        const currentUrl = new URL(window.location.href);
                        // Compare hostnames, ignoring port
                        if (linkUrl.hostname !== currentUrl.hostname) {
                             link.setAttribute('target', '_blank');
                        }
                    } catch (e) {
                        console.error("Invalid URL:", href, e);
                        // If URL is invalid, might still be an external link, add target="_blank" cautiously
                         link.setAttribute('target', '_blank');
                    }
                }
            }
        });


        // Add IDs to headings for deep linking (if not already present)
        contentWrapperDiv.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(heading => {
          if (!heading.id) {
            // Use the generated valid ID based on heading text
            heading.id = generateValidId(heading.textContent.trim());
          }
        });

        // Add copy buttons to pre blocks
        contentWrapperDiv.querySelectorAll('pre').forEach(preElement => {
          if (preElement.querySelector('code') && !preElement.querySelector('.copy-btn')) { // Ensure there's code to copy
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-btn';
            copyButton.textContent = 'Copy';
            copyButton.setAttribute('aria-label', 'Copy code to clipboard');
            copyButton.onclick = () => {
              console.log('Copy button clicked'); // Log click event
              const codeToCopy = preElement.querySelector('code').innerText;
              console.log('Code to copy:', codeToCopy); // Log content to be copied

              navigator.clipboard.writeText(codeToCopy).then(() => {
                console.log('Copy successful!'); // Log success
                copyButton.textContent = 'Copied!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                  copyButton.textContent = 'Copy';
                  copyButton.classList.remove('copied');
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy text: ', err); // Log failure and error
                copyButton.textContent = 'Error';
                  setTimeout(() => {
                  copyButton.textContent = 'Copy';
                }, 2000);
              });
            };
            preElement.appendChild(copyButton);
          }
        });

        hljs.highlightAll(); // Apply syntax highlighting

        // Update active link in navigation
        document.querySelectorAll('#navList a').forEach(navLink => {
          const navHref = navLink.getAttribute('href');
          if (navHref && navHref.startsWith('#')) {
              // Compare the file path part of the hash
              const navFilePath = navHref.substring(1).split('#')[0];
              navLink.classList.toggle('active', navFilePath === filePath);
          } else {
               navLink.classList.toggle('active', false);
          }
        });

        // Scroll to top or to a specific hash if present in the loaded content's URL
        const urlHash = window.location.hash;
        if (urlHash) {
             const hashContent = decodeURIComponent(urlHash.slice(1));
             const hashParts = hashContent.split('#');
             const sectionHashPart = hashParts.length > 1 ? hashParts[1] : ''; // Get the section hash

             if (sectionHashPart) {
                 // Find the element with the valid ID matching the section hash
                 const elementToScroll = contentWrapperDiv.querySelector('#' + generateValidId(sectionHashPart));
                 if(elementToScroll && contentWrapperDiv.contains(elementToScroll)) {
                     elementToScroll.scrollIntoView({ behavior: 'smooth' });
                 } else {
                      console.warn(`Element with ID #${generateValidId(sectionHashPart)} not found in the loaded content.`);
                     contentDiv.scrollTop = 0; // Scroll to top of content if section not found
                 }
             } else {
                 // If no section hash, scroll to top of content
                 contentDiv.scrollTop = 0;
             }
        } else {
             // If no hash at all, scroll to top of content
             contentDiv.scrollTop = 0;
        }


        currentFile = filePath;
      } catch (error) {
        console.error('Failed to load Markdown:', error);
        contentWrapperDiv.innerHTML = `<p style="color:red; font-weight:bold;">Failed to load content for "${filePath}".</p><p style="color:var(--text);">Error: ${error.message}</p><p>Please check the console for more details and ensure the file path is correct in the repository.</p>`;
      }
    }

    function onHashChange() {
      let hash = decodeURIComponent(location.hash.slice(1)); // Decode the hash

      if (!hash) { // If no hash, load default
        hash = 'README.md';
        // Update hash without triggering another hashchange, for bookmarkability
        history.replaceState(null, '', '#' + hash); // Use original file path in hash
      }

      // Split the hash into file path and potential internal section hash
      const hashParts = hash.split('#');
      const filePathFromHash = hashParts[0]; // Get the file path part

      if (filePathFromHash.toLowerCase().endsWith('.md')) {
        if (filePathFromHash !== currentFile) {
          loadMarkdown(filePathFromHash);
        } else {
          // If same file, just scroll to internal hash if present
           const urlHash = window.location.hash;
           if (urlHash && urlHash.length > 1) {
                const hashContent = decodeURIComponent(urlHash.slice(1));
                const hashParts = hashContent.split('#');
                const sectionHashPart = hashParts.length > 1 ? hashParts[1] : ''; // Get the section hash

               if (sectionHashPart) {
                   // Find the element with the valid ID matching the section hash
                   const elementToScroll = contentWrapperDiv.querySelector('#' + generateValidId(sectionHashPart));
                   if(elementToScroll && contentWrapperDiv.contains(elementToScroll)) {
                       elementToScroll.scrollIntoView({ behavior: 'smooth' });
                   } else {
                        console.warn(`Element with ID #${generateValidId(sectionHashPart)} not found in the loaded content.`);
                       contentDiv.scrollTop = 0; // Scroll to top of content if section not found
                   }
               } else {
                   contentDiv.scrollTop = 0; // Scroll to top if no internal hash
               }
           } else {
               contentDiv.scrollTop = 0; // Scroll to top if no hash at all
           }
        }
      } else {
          // If the hash doesn't end with .md, it might be an invalid hash or just an internal section link without a file
          // In this case, try to load the default README.md
           console.warn(`Invalid hash format: ${hash}. Loading default README.md`);
           history.replaceState(null, '', '#README.md'); // Correct the hash
           loadMarkdown('README.md');
      }
    }

    // Update sidebar links to use original file paths on load
    document.querySelectorAll('#navList a').forEach(navLink => {
        const href = navLink.getAttribute('href');
        if (href && href.startsWith('#') && href.includes('.md')) {
            // Keep the original file path in the hash
            // No change needed here as we want #FilePath.md format
        }
    });


    window.addEventListener('hashchange', onHashChange);
    window.addEventListener('load', () => {
        hljs.highlightAll();
        onHashChange(); // Initial load based on hash or default
    });
  </script>
</body>
</html>
