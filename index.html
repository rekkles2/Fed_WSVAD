<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fed_WSVAD Documentation</title>

  <link id="hljs-light" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" />
  <link id="hljs-dark" rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css"
    disabled />

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">

  <style>
    /* —— Color Variables —— */
    :root {
      --bg: #ffffff;
      --text: #24292e;
      --sidebar-bg: #fdfdfd;
      --sidebar-border: #e1e4e8;
      --link: #0366d6;
      --link-hover: #024ea2;
      --active-bg: #e7f4ff; /* A slightly lighter blue for active items */
      --code-bg: #f6f8fa;
      --code-border: #e1e4e8;
      --btn-bg: #0366d6;
      --btn-text: #ffffff;
      --btn-hover: #024ea2;
      --footer-text: #57606a;
      --transition: 0.2s ease-in-out;
      --img-shadow: rgba(0,0,0,0.1);

      /* Table Specific Colors */
      --table-border: #c6cbd1;
      --table-header-bg: #f0f3f6;
      --table-row-even-bg: #f6f8fa;
    }

    body.dark {
      --bg: #0d1117;
      --text: #c9d1d9;
      --sidebar-bg: #161b22;
      --sidebar-border: #30363d;
      --link: #58a6ff;
      --link-hover: #4191db;
      --active-bg: #1f6feb33; /* A subtle blue highlight for dark mode */
      --code-bg: #161b22;
      --code-border: #30363d;
      --btn-bg: #238636;
      --btn-text: #ffffff;
      --btn-hover: #196e2d;
      --footer-text: #8b949e;
      --img-shadow: rgba(0,0,0,0.3);

      /* Table Specific Colors (Dark Mode) */
      --table-border: #444c56;
      --table-header-bg: #21262d;
      --table-row-even-bg: #1c222b;
    }

    /* —— Base Styles —— */
    * {
      box-sizing: border-box;
      transition: background-color var(--transition),
        color var(--transition), border-color var(--transition);
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica,
        Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      font-size: 16px;
      line-height: 1.7;
      color: var(--text);
      background-color: var(--bg);
      display: flex; /* Use flexbox for main layout */
      height: 100vh;
      overflow: hidden; /* Hide overflow on body to manage scrolling on #content */
    }

    /* —— Sidebar —— */
    #sidebar {
      position: fixed; /* Keep fixed position */
      top: 0;
      left: 0;
      bottom: 0;
      width: 260px; /* Fixed width sidebar */
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1.5rem 1rem;
      flex-shrink: 0; /* Prevent sidebar from shrinking in flex layout */
    }

    #navList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #navList li {
      margin: 0.6rem 0;
    }

    #navList a, #navList .folder {
      display: block;
      text-decoration: none;
      color: var(--link);
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      font-weight: 500;
      word-wrap: break-word; /* Ensure long text wraps */
    }
      #navList .folder {
        color: var(--text);
        font-weight: 600;
        cursor: default;
      }


    #navList a:hover {
      background-color: var(--active-bg);
      color: var(--link-hover);
    }

    #navList a.active {
      background-color: var(--active-bg);
      color: var(--link-hover);
      font-weight: 700;
    }

    #navList ul {
      margin-left: 1.2rem;
      padding-left: 0.5rem;
      border-left: 1px solid var(--sidebar-border);
    }
      #navList ul li {
        margin: 0.4rem 0;
      }

    .maintainer {
      margin-top: auto; /* Pushes the element to the bottom */
      padding-top: 1.5rem;
      font-size: 1.3rem; /* Slightly larger maintainer text */
      color: var(--footer-text);
      text-align: left;
      padding-left: 0.8rem;
      font-family: 'Pacifico', cursive; /* Apply Pacifico font */
      font-weight: 700; /* Make it bold */
    }

    /* —— Theme Toggle Button —— */
    #themeToggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      border: 1px solid var(--sidebar-border);
      background-color: var(--sidebar-bg);
      color: var(--text);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
    }

    #themeToggle:hover {
      background-color: var(--code-bg);
      border-color: var(--link);
    }
    #themeToggle:active {
        transform: scale(0.95);
    }

    /* —— Back Button —— */
    #backButton {
      position: fixed;
      top: 3rem; /* Moved down to avoid overlap */
      left: calc(260px + 1rem); /* Position to the right of the sidebar + 1rem margin */
      z-index: 1000;
      border: 1px solid var(--sidebar-border);
      background-color: var(--sidebar-bg);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color var(--transition), color var(--transition), border-color var(--transition), transform 0.1s ease;
    }

    #backButton:hover {
      background-color: var(--code-bg);
      border-color: var(--link);
    }
     #backButton:active {
        transform: scale(0.95);
    }


    /* —— Content Area (Full width next to sidebar, handles scrolling) —— */
    #content {
      flex-grow: 1; /* Allow content to grow and fill space */
      overflow-y: auto; /* Add scrollbar to this area */
      padding: 0; /* Remove padding here, apply to wrapper */
      margin-left: 260px; /* Push content area next to sidebar */
    }

    /* —— Badges Container (Directly added to HTML) —— */
    #topBadges {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 0;
      margin: 1.5em 0;
      width: auto;
      padding: 0 2.5rem;
      box-sizing: border-box;
      align-self: flex-start;
    }

    #topBadges img {
        max-width: none;
        height: auto;
        display: inline-block;
        margin: 0;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        background-color: transparent;
    }

    #topBadges a {
        text-decoration: none;
    }


    /* —— Content Wrapper (Centers content within #content) —— */
    .content-wrapper {
      max-width: 75%;
      width: 100%;
      margin: 0 auto;
      padding: 0 2.5rem;
      padding-top: 0;
      padding-bottom: 2rem;
      box-sizing: border-box;
      flex-shrink: 0;
      align-self: center;
    }

    /* —— Table of Contents Styling —— */
    .content-wrapper ol:first-of-type,
    .content-wrapper ul:first-of-type {
        list-style: none;
        padding-left: 0;
        margin-top: 1.5em;
        margin-bottom: 2em;
        background-color: var(--code-bg);
        border: 1px solid var(--code-border);
        border-radius: 8px;
        padding: 1.5em;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .content-wrapper ol:first-of-type ul,
    .content-wrapper ul:first-of-type ul {
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        padding-left: 1.5em;
        border-left: 2px solid var(--sidebar-border);
    }

    .content-wrapper ol:first-of-type li,
    .content-wrapper ul:first-of-type li {
        margin-bottom: 0.8em;
        line-height: 1.4;
        position: relative;
        padding-left: 1.2em;
    }

     .content-wrapper ol:first-of-type ul li,
     .content-wrapper ul:first-of-type ul li {
        margin-bottom: 0.4em;
    }

    /* Custom marker for ToC list items */
    .content-wrapper ol:first-of-type li::before,
    .content-wrapper ul:first-of-type li::before {
        content: "➤";
        color: var(--link);
        position: absolute;
        left: 0;
        top: 0.1em;
        font-size: 0.8em;
        font-weight: bold;
    }
     .content-wrapper ol:first-of-type ul li::before,
     .content-wrapper ul:first-of-type ul li::before {
         content: "•";
         color: var(--footer-text);
         font-size: 1em;
         top: 0.2em;
     }

    .content-wrapper li a {
        font-weight: 400;
        text-decoration: none;
        color: var(--text);
        transition: color var(--transition);
    }

    .content-wrapper li a:hover {
        color: var(--link);
        text-decoration: underline;
    }

    /* Style for the ToC heading (if it's an h2) */
    .content-wrapper h2:first-of-type {
        margin-top: 0;
        margin-bottom: 1.5em;
        border-bottom: none;
        padding-bottom: 0;
        font-size: 1.6em;
        color: var(--text);
    }

    /* —— Headings —— */
    .content-wrapper h1,
    .content-wrapper h2,
    .content-wrapper h3,
    .content-wrapper h4,
    .content-wrapper h5,
    .content-wrapper h6 {
      margin-top: 2em;
      margin-bottom: 1em;
      font-weight: 600;
      line-height: 1.3;
    }

    .content-wrapper h1 {
      font-size: 2.2em;
      border-bottom: 1px solid var(--sidebar-border);
      padding-bottom: 0.4em;
    }

    .content-wrapper h2 {
      font-size: 1.8em;
        border-bottom: 1px dashed var(--sidebar-border);
        padding-bottom: 0.3em;
    }
    .content-wrapper h3 {
        font-size: 1.4em;
    }

    /* —— Paragraphs —— */
    .content-wrapper p {
      margin: 0 0 1.2em 0;
    }

    /* —— Code & Preformatted Blocks —— */
    .content-wrapper pre {
      background-color: var(--code-bg);
      border: 1px solid var(--code-border);
      padding: 1.2rem;
      border-radius: 8px;
      position: relative;
      overflow-x: auto;
      margin: 1.5em 0;
    }

    .content-wrapper code:not(pre code) { /* Inline code */
      background-color: var(--code-bg);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-size: 0.9em;
      border: 1px solid var(--code-border);
    }
    .content-wrapper pre code { /* Code within pre blocks */
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
      font-size: 0.95em;
      background-color: transparent;
      border: none;
      padding: 0;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 5px;
      cursor: pointer;
      opacity: 0.7;
      transition: background-color var(--transition), color var(--transition), opacity 0.15s ease;
    }
    .content-wrapper pre:hover .copy-btn {
        opacity: 1;
    }

    .copy-btn:hover {
      background: var(--btn-hover);
      opacity: 1;
    }
    .copy-btn.copied {
        background: #28a745;
        color: white;
    }

    /* —— Links, Tables, Blockquotes —— */
    .content-wrapper a {
      color: var(--link);
      text-decoration: none;
    }

    .content-wrapper a:hover {
      text-decoration: underline;
      color: var(--link-hover);
    }

    .content-wrapper table {
      border-collapse: collapse;
      width: 100%;
      margin: 1.8em 0;
      box-shadow: 0 2px 4px var(--img-shadow);
      border-radius: 6px;
      overflow: hidden;
    }

    .content-wrapper th,
    .content-wrapper td {
      border: 1px solid var(--table-border);
      padding: 0.8em 1.2em;
      text-align: left;
    }
    .content-wrapper th {
        background-color: var(--table-header-bg);
        font-weight: 600;
    }
    .content-wrapper tr:nth-child(even) {
        background-color: var(--table-row-even-bg);
    }

    .content-wrapper blockquote {
      border-left: 5px solid var(--link);
      padding: 1em 1.5em;
      margin: 1.8em 0;
      background-color: var(--code-bg);
      border-radius: 0 6px 6px 0;
      color: var(--footer-text);
    }
    .content-wrapper blockquote p:last-child {
        margin-bottom: 0;
    }

    /* —— Images (including SVG) —— */
    .content-wrapper img {
      max-width: 55%;
      height: auto;
      display: block;
      margin: 1.5em auto;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--img-shadow);
      background-color: var(--bg);
    }

    /* —— Key Contributions List Styling —— */
    .content-wrapper ul:not(:first-of-type) {
        list-style: none;
        padding-left: 1.5em;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
    }

     .content-wrapper ul:not(:first-of-type) li {
         margin-bottom: 0.8em;
         position: relative;
     }

     /* Custom marker for Key Contributions list items */
     .content-wrapper ul:not(:first-of-type) li::before {
         content: "→";
         color: var(--link);
         position: absolute;
         left: -1.5em;
         top: 0.1em;
         font-weight: bold;
     }

  </style>
</head>
<body>
  <nav id="sidebar">
    <div class="nav-container">
      <ul id="navList">
        <li><a href="#README.md">Home</a></li>
        <li><span class="folder">Backbone">Backbone</span>
          <ul>
            <li><a href="#Backbone/README.md">Feature Extraction Guide (VideoMAE V2 Backbone)</a></li>
          </ul>
        </li>
        <li><span class="folder">Fed_VAD">Fed_VAD</span>
          <ul>
            <li><a href="#Fed_VAD/Jetson%20AGX%20Xavier%20Deployment%20Guide.md">Jetson AGX Xavier Deployment Guide</a></li>
            <li><a href="#Fed_VAD/README.md">Federated Setup (Fed-WSVAD)</a></li>
          </ul>
        </li>
        <li><a href="https://deepwiki.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer">DeepWiki Code Navigator</a></li>
      </ul>
    </div>
    <div class="maintainer">Maintained by Jiahang Li</div>
  </nav>

  <button id="themeToggle" aria-label="Toggle dark/light mode">🌙</button>
  <button id="backButton">← Back</button>

  <main id="content">
    <div id="topBadges">
      <a href="https://github.com/rekkles2/Fed_WSVAD" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/github/stars/rekkles2/Fed_WSVAD?style=flat-square&logo=github&logoColor=white"
          alt="GitHub Stars"
        />
      </a>
      <a href="https://rekkles2.github.io/Fed_WSVAD/#README.md" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/badge/%F0%9F%8C%90-Project%20Page-0084FF?style=flat-square"
          alt="Project Page"
        />
      </a>
      <a href="https://github.com/rekkles2/Fed_WSVAD/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">
        <img
          src="https://img.shields.io/github/license/rekkles2/Fed_WSVAD?style=flat-square&logo=apache&logoColor=white&color=brightgreen"
          alt="License"
        />
      </a>
    </div>
    <div class="content-wrapper">
      <p>Loading...</p>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/15.0.7/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script>
    // --- Theme Toggle Functionality ---
    const themeToggleBtn = document.getElementById('themeToggle');
    const lightStyle = document.getElementById('hljs-light');
    const darkStyle = document.getElementById('hljs-dark');
    const savedTheme = localStorage.getItem('theme');

    function applyTheme(theme) {
      if (theme === 'dark') {
        document.body.classList.add('dark');
        if (lightStyle) lightStyle.disabled = true;
        if (darkStyle) darkStyle.disabled = true;
        themeToggleBtn.textContent = '☀️'; // Sun icon for dark mode
      } else {
        document.body.classList.remove('dark');
        if (lightStyle) lightStyle.disabled = false;
        if (darkStyle) darkStyle.disabled = true;
        themeToggleBtn.textContent = '🌙'; // Moon icon for light mode
      }
    }

    // Apply saved theme or system preference on load
    applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    // Event listener for theme toggle button
    themeToggleBtn.addEventListener('click', () => {
      const newTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('theme', newTheme);
    });

    // --- Markdown Loading and Processing ---
    const contentDiv = document.getElementById('content');
    const contentWrapperDiv = contentDiv.querySelector('.content-wrapper');
    let currentFile = null; // Tracks the currently loaded markdown file
    const GITHUB_REPO_RAW_BASE_URL = 'https://raw.githubusercontent.com/rekkles2/Fed_WSVAD/main/';
    const HOME_README_URL = 'https://raw.githubusercontent.com/rekkles2/page/main/README.md';


    // Generates a valid HTML ID from a string (e.g., for heading anchors)
    function generateValidId(input) {
        // Replace invalid characters with hyphens, remove leading/trailing hyphens
        return input.trim().toLowerCase()
                    .replace(/[^\w\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-')
                    .replace(/^-+|-+$/g, '');
    }

    // Fetches and renders Markdown content
    async function loadMarkdown(filePath) {
      // Clear previous content and display loading message
      contentWrapperDiv.innerHTML = '<p>Loading content...</p>';

      try {
        // Determine the correct URL for the markdown file
        const isHomePage = filePath === 'README.md';
        const fileUrl = isHomePage ? HOME_README_URL : GITHUB_REPO_RAW_BASE_URL + filePath;
        const response = await fetch(fileUrl);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status} for ${fileUrl}`);
        }
        const markdownText = await response.text();

        // Parse Markdown to HTML using 'marked' library
        let parsedHtml = marked.parse(markdownText);

        // Insert parsed markdown into the content wrapper
        contentWrapperDiv.innerHTML = parsedHtml;


        // --- Link Handling ---
        // Determine the base URL for resolving relative links within the current markdown file
        const currentFileDirectory = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/') + 1) : '';
        const baseUrlForRelativeLinks = (isHomePage) ?
                                       new URL(HOME_README_URL).href.substring(0, new URL(HOME_README_URL).href.lastIndexOf('/') + 1) : // Base of the 'page' repo
                                       new URL(currentFileDirectory, GITHUB_REPO_RAW_BASE_URL).href;

        // After inserting HTML, find all links and headings to correct internal links
        const headings = contentWrapperDiv.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const links = contentWrapperDiv.querySelectorAll('a');

        // Generate IDs for headings if they don't have them
        headings.forEach(heading => {
            if (!heading.id) {
                 heading.id = generateValidId(heading.textContent.trim());
            }
        });


        links.forEach(link => {
          const href = link.getAttribute('href');
          if (href) {
            // Handle relative links (not starting with #, http, mailto)
            if (!href.startsWith('#') && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('mailto:')) {
              const parts = href.split('#');
              const pathPart = parts[0];
              const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';

              if (pathPart.toLowerCase().endsWith('.md')) {
                // Convert relative .md links to internal hash links for SPA navigation
                let absolutePath;
                // Resolve relative path based on the current markdown file's directory
                absolutePath = new URL(pathPart, baseUrlForRelativeLinks).pathname;
                // Make path relative to GITHUB_REPO_RAW_BASE_URL's path part if it's not the home page
                 if (!isHomePage) {
                     let baseRepoPath = new URL(GITHUB_REPO_RAW_BASE_URL).pathname;
                     if (absolutePath.startsWith(baseRepoPath)) {
                        absolutePath = absolutePath.substring(baseRepoPath.length);
                     }
                 }
                 absolutePath = absolutePath.replace(/^\//, ''); // Ensure no leading slash for hash

                link.setAttribute('href', '#' + absolutePath + internalHashPart); // Use original path in hash

              } else {
                // Convert other relative links (assets, etc.) to absolute raw GitHub URLs
                const absoluteUrl = new URL(href, baseUrlForRelativeLinks).href;
                link.setAttribute('href', absoluteUrl);
                link.setAttribute('target', '_blank'); // Open asset links in new tab
                link.setAttribute('rel', 'noopener noreferrer');
              }
            } else if (href.startsWith('https://github.com/rekkles2/Fed_WSVAD/blob/main/')) {
              // Convert GitHub blob links to internal hash links
              const repoPathWithHash = href.substring('https://github.com/rekkles2/Fed_WSVAD/blob/main/'.length);
              const parts = repoPathWithHash.split('#');
              const pathPart = parts[0];
              const internalHashPart = parts.length > 1 ? '#' + parts.slice(1).join('#') : '';
              link.setAttribute('href', '#' + pathPart + internalHashPart);
            } else if (href.startsWith('#') && href.length > 1) {
                // It's an internal page hash link (e.g., #section)
                const originalSectionId = href.substring(1); // Get the original section ID from Markdown

                // Try to find a heading element whose generated ID matches the original section ID
                // Convert NodeList to Array to use find() method
                const headingsArray = Array.from(headings);
                let targetElement = headingsArray.find(heading => generateValidId(heading.textContent.trim()) === generateValidId(originalSectionId));

                // Fallback: If finding by generated ID of heading text fails,
                // try finding by the exact originalSectionId from the link's href.
                // This is necessary because Markdown parsers might generate IDs differently
                // for list items compared to headings.
                if (!targetElement) {
                     targetElement = contentWrapperDiv.querySelector('#' + originalSectionId);
                }

                // Final fallback: Try to find an element whose text content closely matches the link text
                // This is less reliable but can help with some cases where IDs are unpredictable.
                 if (!targetElement) {
                     const linkText = link.textContent.trim();
                     if (linkText) {
                         // Look for any element that might contain this text and is a potential target
                         // This is a broad search and might need refinement based on actual HTML structure
                         // We'll try to find a heading with matching text content first
                         targetElement = headingsArray.find(heading => heading.textContent.trim() === linkText);

                         // If not found in headings, try a broader search within the content wrapper
                         if (!targetElement) {
                             targetElement = contentWrapperDiv.querySelector(`*:has(a[href="${href}"])`); // Find the parent element of the link
                             if (targetElement && targetElement !== link.parentElement) {
                                  // If the parent is found and it's not just the link itself,
                                  // try to find a heading or other block element within it
                                  targetElement = targetElement.querySelector('h1, h2, h3, h4, h5, h6, p, div'); // Broad search
                             }
                         }
                         // As a last resort, try finding any element with a matching generated ID from the link text
                         if (!targetElement) {
                              const generatedIdFromLinkText = generateValidId(linkText);
                              targetElement = contentWrapperDiv.querySelector('#' + generatedIdFromLinkText);
                         }
                     }
                 }


                if (targetElement && targetElement.id) {
                     // If a target element with an ID is found, update the link href to point to its ID
                     link.setAttribute('href', '#' + filePath + '#' + targetElement.id); // Format: #FilePath.md#target-id
                } else {
                    console.warn(`Could not find a reliable target element for internal link: ${href} in ${filePath}. Link text: "${link.textContent.trim()}"`);
                     // If target not found, modify to a potentially invalid hash that includes the file path
                     link.setAttribute('href', '#' + filePath + href); // Keep original hash part but add file path
                }
            }

             // Ensure all external HTTP/HTTPS links open in a new tab
             if ((href.startsWith('http://') || href.startsWith('https://')) && !link.getAttribute('href').startsWith('#')) {
                // Check if it's not already targeting _blank and not an internal SPA link
                if (link.getAttribute('target') !== '_blank') {
                    try {
                        const linkUrl = new URL(link.href); // Use link.href to get absolute URL
                        const currentLocUrl = new URL(window.location.href);
                        if (linkUrl.hostname !== currentLocUrl.hostname || linkUrl.protocol !== currentLocUrl.protocol) {
                            link.setAttribute('target', '_blank');
                            link.setAttribute('rel', 'noopener noreferrer');
                        }
                    } catch (e) {
                        console.error("Error processing link URL for target='_blank':", href, e);
                        // Fallback for potentially malformed relative links that became absolute
                        if (!link.href.startsWith(window.location.origin + window.location.pathname)) {
                             link.setAttribute('target', '_blank');
                             link.setAttribute('rel', 'noopener noreferrer');
                        }
                    }
                }
            }
          }
        });

        // Add IDs to headings if they don't have them (Redundant after first pass, but harmless)
        headings.forEach(heading => {
            if (!heading.id) {
                 heading.id = generateValidId(heading.textContent.trim());
            }
        });


        // Add "Copy" buttons to code blocks
        contentWrapperDiv.querySelectorAll('pre').forEach(preElement => {
          if (preElement.querySelector('code') && !preElement.querySelector('.copy-btn')) {
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-btn';
            copyButton.textContent = 'Copy';
            copyButton.setAttribute('aria-label', 'Copy code to clipboard');
            copyButton.onclick = () => {
              const codeToCopy = preElement.querySelector('code').innerText;
              navigator.clipboard.writeText(codeToCopy).then(() => {
                copyButton.textContent = 'Copied!';
                copyButton.classList.add('copied');
                setTimeout(() => {
                  copyButton.textContent = 'Copy';
                  copyButton.classList.remove('copied');
                }, 2000);
              }).catch(err => {
                console.error('Failed to copy text: ', err);
                copyButton.textContent = 'Error';
                setTimeout(() => { copyButton.textContent = 'Copy'; }, 2000);
              });
            };
            preElement.appendChild(copyButton);
          }
        });

        // Apply syntax highlighting using highlight.js
        if (typeof hljs !== 'undefined') {
            hljs.highlightAll();
        }


        // Update active link in the sidebar navigation
        document.querySelectorAll('#navList a').forEach(navLink => {
          const navHref = navLink.getAttribute('href');
          // Only apply 'active' to internal hash links
          if (navHref && navHref.startsWith('#')) {
            const navFilePath = navHref.substring(1).split('#')[0]; // Compare file path part of the hash
            navLink.classList.toggle('active', navFilePath === filePath);
          } else {
            navLink.classList.remove('active'); // External links should not be marked active
          }
        });

        // Scroll to the top of the content or to a specific section if a hash is present
        const urlHash = window.location.hash;
        if (urlHash) {
          const hashContent = decodeURIComponent(urlHash.slice(1));
          const hashParts = hashContent.split('#');
          const filePartOfHash = hashParts[0]; // e.g., README.md or Backbone/README.md
          const sectionHashPart = hashParts.length > 1 ? hashParts[1] : ''; // e.g., introduction

          // Only scroll if the file part of the hash matches the currently loaded file
          if (filePartOfHash === filePath && sectionHashPart) {
            // Find the element with the valid ID matching the section hash (which should be the generated ID)
            const elementToScroll = contentWrapperDiv.querySelector('#' + sectionHashPart);
            if (elementToScroll && contentWrapperDiv.contains(elementToScroll)) {
              elementToScroll.scrollIntoView({ behavior: 'smooth' });
            } else {
              console.warn(`Element with ID #${sectionHashPart} not found in ${filePath}.`);
              contentDiv.scrollTop = 0; // Scroll to top if section not found
            }
          } else if (filePartOfHash === filePath) { // File matches, but no specific section
            contentDiv.scrollTop = 0;
          }
          // If filePartOfHash does not match filePath, scrolling is handled by the new page load.
        } else {
          contentDiv.scrollTop = 0; // Scroll to top if no hash at all
        }

        currentFile = filePath; // Update the currently loaded file
      } catch (error) {
        console.error('Failed to load Markdown:', error);
        contentWrapperDiv.innerHTML = `<p style="color:red; font-weight:bold;">Failed to load content for "${filePath}".</p><p style="color:var(--text);">Error: ${error.message}</p><p>Please check the console for more details.</p>`;
      }
    }

    // Handles URL hash changes for navigation
    function onHashChange() {
      let hash = decodeURIComponent(location.hash.slice(1));

      if (!hash) { // If no hash, load default README.md
        hash = 'README.md';
        history.replaceState(null, '', '#' + hash); // Update URL without triggering hashchange
      }

      const hashParts = hash.split('#');
      const filePathFromHash = hashParts[0]; // This is the path to the .md file

      if (filePathFromHash && filePathFromHash.toLowerCase().endsWith('.md')) {
        // If the file path from hash is different from currentFile, load it.
        // Or, if it's the same file but currentFile is null (initial load), load it.
        if (filePathFromHash !== currentFile || currentFile === null) {
          loadMarkdown(filePathFromHash);
        } else {
          // Same file is already loaded, just handle scrolling to section if specified
          const sectionHashPart = hashParts.length > 1 ? hashParts[1] : '';
          if (sectionHashPart) {
            // Find the element with the valid ID matching the section hash (which is a generated ID)
            const elementToScroll = contentWrapperDiv.querySelector('#' + sectionHashPart);
            if (elementToScroll && contentWrapperDiv.contains(elementToScroll)) {
              elementToScroll.scrollIntoView({ behavior: 'smooth' });
            } else {
                 console.warn(`Element with ID #${sectionHashPart} not found for same-file scroll in ${filePathFromHash}.`);
                 contentDiv.scrollTop = 0; // Scroll to top if section not found
            }
          } else {
            contentDiv.scrollTop = 0; // Scroll to top if no internal hash for the same file
          }
        }
      } else if (filePathFromHash) { // If hash is not an .md file but exists
        console.warn(`Invalid or non-Markdown file path in hash: "${filePathFromHash}". Loading default README.md`);
        history.replaceState(null, '', '#README.md');
        loadMarkdown('README.md');
      }
      // If filePathFromHash is empty (e.g. URL is just `#`), it defaults to README.md due to the `!hash` check earlier.
    }

    // Ensure sidebar links and badge links are correctly formatted for external targets
    document.querySelectorAll('#sidebar a, #topBadges a').forEach(link => {
        const href = link.getAttribute('href');
        if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            // Check if it's not already targeting _blank and not an internal SPA link
            if (!link.hasAttribute('target') || link.getAttribute('target') !== '_blank') {
                try {
                    const linkUrl = new URL(link.href); // Use link.href to get absolute URL
                    const currentLocUrl = new URL(window.location.href);
                    if (linkUrl.hostname !== currentLocUrl.hostname || linkUrl.protocol !== currentLocUrl.protocol) {
                        link.setAttribute('target', '_blank');
                        link.setAttribute('rel', 'noopener noreferrer');
                    }
                } catch (e) {
                    console.error("Error processing link URL for target='_blank':", href, e);
                     link.setAttribute('target', '_blank');
                     link.setAttribute('rel', 'noopener noreferrer');
                }
            }
        }
    });

    // Add event listener for the back button
    document.getElementById('backButton').addEventListener('click', () => {
        history.back();
    });


    // Event listeners for page load and hash changes
    window.addEventListener('hashchange', onHashChange);
    window.addEventListener('load', () => {
      if (typeof hljs !== 'undefined') {
        // Ensure highlight.js is available before calling
        hljs.configure({ ignoreUnescapedHTML: true }); // Optional: good for robustness
        // Initial highlighting might be better done after first loadMarkdown completes
      }
      onHashChange(); // Initial content load based on hash or default
    });
  </script>
</body>
</html>
